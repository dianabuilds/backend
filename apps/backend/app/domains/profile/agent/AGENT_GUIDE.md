# Agent Guide — Profile Domain

Цель: стандартизировать работу ИИ‑агента для домена Profile. Документ дополняет общий `backend/AGENTS.md` и задаёт доменные правила, DoD и формат артефактов.

## Scope и разрешённые файлы
- Разрешено: `app/domains/profile/**`, `app/schemas/profile.py`, при необходимости `app/domains/registry.py` (подключение роутов).
- Запрещено править код других доменов, если это не явная зависимость.
- Миграции — строго в корневом Alembic. В домене храним дизайн-спеки в `schema/sql/` и описания в ADR.

## Definition of Done
- План → Тесты → Код → Самоаудит → PR (см. общий контракт в `AGENTS.md`).
- API синхронизирован: `schema/openapi.yaml` согласован с FastAPI-ручками и моделями `ProfileOut/ProfileUpdate`.
- Инварианты и политики соблюдены: публичное чтение, изменять может только владелец.
- События: `event.profile.updated.v1` публикуется через outbox при изменениях; схема в `events/specs` актуальна.
- Типизация mypy ok, линтеры ok, тесты по профилю зелёные.

## Контракты API
- Ответ: `ProfileOut { id, userId, username?, avatar?, bio?, lang? }` в `app/schemas/profile.py`.
- Изменение: `ProfileUpdate { username?, avatar?, bio?, lang? }`.
- Любые изменения контрактов: сначала правка `schema/openapi.yaml`, затем модели/ручки/тесты. Только ап‑совместимые изменения.

## Инварианты и политики
- Чтение профиля доступно публично.
- Обновление профиля — только владелец (subject.id == user_id). Проверка в роуте через `can_update_profile`.
- Изменения username/avatar/bio пишутся в таблицу `users`; `lang` — в `user_profiles.locale`.

## События
- При PATCH публикуется `event.profile.updated.v1` через `app.domains.system.platform.outbox.emit` (фасад System Outbox).
- Правило версионирования событий: только добавление полей без удаления; breaking → новый суффикс `.vN+1` и новый паблишер.

## Слои и зависимости
- `application` не импортирует `infrastructure` (кроме типов Protocol), порты в `application/ports`, реализации — в `infrastructure/repositories`.
- В роутере допускается DI конкретной реализации репозитория.

## Тесты
- Unit: сервис и политики (`tests/unit`).
- Интеграционные/контрактные: формы ввода/вывода и факт публикации события (мок/фикстура outbox).
- Минимум: тест на успешное обновление своего профиля и отказ при попытке менять чужой.

## Наблюдаемость и перформанс
- Логи при публикации события (на уровне INFO/DEBUG опционально). Время ответа p95 ⩽ 120ms.

## Коммиты и артефакты
- Коммиты: `feat(domain-profile): ...`, `fix(domain-profile): ...`.
- ADR при изменении схем/событий/политик.
- В PR: ссылаться на изменённые схемы, прикладывать дамп OpenAPI diff (если есть).

## Запреты
- Бизнес‑логика в контроллерах (кроме авторизации/валидации и оркестрации).
- Кросс‑доменные импорты без портов. Прямой доступ к БД из `api` (только через репозитории/сервисы).

Смотри также границы с доменом Users: `docs/architecture/users_profile_boundaries.md`.
