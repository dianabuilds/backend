# Предварительные действия перед имплементацией контуров

Документ фиксирует, какие домены нужно создать или переименовать, их целевую структуру, порядок миграции ручек и правила постановки задач. Используется как чек-лист до начала активной разработки.

## Новые домены и переименования

| Домен | Статус | Действие | Назначение |
|-------|--------|----------|------------|
| `apps/backend/domains/platform/ops` | новый | Переименование текущего `platform/admin`, разбиение по подсекциям `billing`, `system`, `integrations` | Контур `ops`, высокорисковые операции (финансы, системные настройки, интеграции) |
| `apps/backend/domains/platform/moderation/api/public` | новый подпакет | Выделить read-only/публичные сценарии, если появятся (пока пустой шаблон) | Разделение модерационных ручек по контурам |
| `apps/backend/domains/platform/moderation/api/admin` | реорганизация | Перенести существующие административные контроллеры в подпакет | Контур `admin` для модераторов |
| `apps/backend/domains/platform/core/api/{public,admin,ops}` | реорганизация | Разделить текущие контроллеры по контурам, вынести общие зависимости | Управление пользовательскими и административными настройками |
| `apps/backend/domains/platform/users/api/{public,admin}` | реорганизация | Выделить публичные и админские ручки | Контур `public` (self-service) и `admin` (управление пользователями) |
| `apps/backend/domains/product/*/api/{public,admin}` | реорганизация | Добавить зеркальную структуру для всех продуктовых доменов (`achievements`, `profile`, `quests`, `referrals`, `tags`, и др.) | Одинаковый каркас для пользовательских и административных сценариев |
| `apps/backend/app/api_gateway/middlewares/audience.py` | новый | Общая проверка `audience/role` и выбор контура | Единая точка политики доступа |
| `apps/backend/app/api_gateway/deps/{public,admin,ops}.py` | новый | Провайдеры зависимостей (security, rate limits, creds) по каждому контуру | Упрощение DI в доменах |
| `apps/backend/infra/db/config.py` | расширение | Описание отдельных DSN/пулов для контуров | Ограничение доступов к БД |

> Примечание: для новых подпакетов (`api/public`, `api/admin`, `api/ops`) создаём шаблонные `__init__.py` и базовые `router.py`/`http.py`, чтобы модули были готовы к миграции.

## Стандартная структура домена

```
domain/
├── api/
│   ├── public/
│   │   ├── http.py          # Маршруты публичного контура
│   │   └── register.py      # Регистрация роутера (опционально)
│   ├── admin/
│   │   ├── http.py          # Маршруты административного контура
│   │   └── register.py
│   └── ops/                 # Только для доменов высокого риска
│       ├── http.py
│       └── register.py
├── application/
│   ├── public_service.py    # Use-case'ы публичного контура
│   ├── admin_service.py     # Use-case'ы админского контура
│   └── ops_service.py       # Для `ops`, если требуется
├── domain/                  # Бизнес-логика и сущности
├── adapters/                # Взаимодействие с внешними системами/БД
├── schemas_public.py        # DTO для публичного API (опционально)
├── schemas_admin.py         # DTO для административного API
└── wires.py                 # Настройка DI и контейнеров
```

- Для доменов, где услуги идентичны во всех контурах, допускается объединение `application/public_service.py` и `application/admin_service.py` с явным контролем доступа в методах.
- В продуктовых доменах структура остаётся как в примере выше. В платформенных допускаются дополнительные подпапки (`ops/billing.py`, `ops/system.py`) в зависимости от предметной области.

## Порядок переноса и создания доменов

1. **Подготовка инфраструктуры (неделя 1)**  
   - Создать новые подпакеты и инфраструктурные модули (`middlewares`, `deps`, `db/config.py`).  
   - Настроить feature-флаги `admin_contour.enabled`, `ops_contour.enabled`.

2. **Модерация (`platform.moderation`) (недели 1–2)**  
   - Перенести все `/api/moderation/**` в `api/admin`.  
   - Включить middleware `audience/role`, обновить DI.  
   - Провести smoke-тесты модераторского UI.

3. **Платформенные сервисы общего назначения (недели 2–3)**  
   - Разделить `platform/core` и `platform/users` на `public`/`admin`.  
   - Настроить отдельные креды БД и rate limits.  

4. **Продуктовые домены (недели 3–4)**  
   - `product/achievements`, `product/profile`, `product/quests`, `product/referrals`, `product/tags`.  
   - Для каждого домена: перенести `/v1/admin/**` в `api/admin`, обновить сервисные слои и DTO.  
   - Включить флаг `admin_contour.product` после валидации.

5. **Поисковый и квотовый сервисы (неделя 4)**  
   - Перенести `/v1/search/index`, `/v1/search/{doc_id}` и `/v1/quota/**` в `api/admin`.  
   - Скорректировать rate limiting и аудит.

6. **Operations-контур (недели 5–6)**  
   - Переименовать `platform/admin` → `platform/ops`, разнести эндпоинты по подпакетам (`ops/billing`, `ops/system`).  
  - Перенести `/v1/settings/billing/**`, `/healthz` (если требуется) и системные интеграции в новый контур.  
   - Подключить mTLS и ops-учётки на уровне инфраструктуры.

7. **Финализация и cleanup (неделя 6)**  
   - Удалить временные адаптеры/прокси.  
   - Обновить документацию (`endpoints.md`, `findings.md`, ADR).  
   - Зафиксировать результаты миграции и открыть задачи на долгосрочные улучшения (логирование, наблюдаемость).

## Базовая инфраструктура и окружение

### Что меняем
- Расширяем `.env` и `apps/backend/.env` переменными для контуров: `APP_CONTOUR` (значения `public|admin|ops`), `DATABASE_URL_<CONTOUR>`, `REDIS_URL_<CONTOUR>`, `FEATURE_FLAG_<CONTOUR>`.
- В `apps/backend/app/api_gateway/main.py` добавляем фабрику приложений, принимающую значение контура и подключающую нужные регистраторы.
- Обновляем `container_registry.py` и `wires.py`, чтобы они получали контур из env и выбирали соответствующие зависимости.
- В `docker-compose.yml` заводим отдельные службы `backend-public`, `backend-admin`, `backend-ops` (по профилю `local`), каждая задаёт `APP_CONTOUR` и использует свой `.env` (через `env_file` или `environment`).
- Добавляем в `Makefile` цели `run-public`, `run-admin`, `run-ops`, проксирующие вызов `uvicorn` с соответствующим env. Цель `make run` помечаем как legacy и делегируем к выбранному контуру.
- Для CI обновляем матрицу пайплайнов (GitHub Actions/GitLab) так, чтобы тесты гонялись для всех контуров: `pytest --contour=public|admin|ops`, линтеры общие.

### Запуск проекта
- **Локально (Docker Compose)**:  
  `docker compose --profile local up backend-public admin postgres redis` — публичный контур и фронтенд.  
  `docker compose --profile local up backend-admin` — административный контур.  
  `docker compose --profile local up backend-ops` — ops-контур (по мере готовности).
- **Локально (без Docker)**:  
  ```
  cd apps/backend
  APP_CONTOUR=admin DATABASE_URL=$(grep DATABASE_URL_ADMIN .env | cut -d= -f2-) \
  poetry run uvicorn app.api_gateway.main:create_app --factory --reload
  ```
  Аналогично для `public` и `ops` с соответствующими переменными.
- **Тесты**: `make test` разворачивает окружение контура по умолчанию (`public`). Для дополнительных контуров — `make test-admin` / `make test-ops`, которые устанавливают нужные env.

### Необходимые действия
1. Подготовить шаблоны `.env.example` с секциями `[public]`, `[admin]`, `[ops]`, обновить инструкции в `apps/backend/README.md`.
2. Обновить `docker-compose.yml` и `Makefile`, проверить запуск всех сервисов локально.
3. Внести изменения в pipeline CI (например, `ci.yml`): матрица по контурам, отдельные шаги smoke-тестов.  
4. Пересобрать dev-образы в registry (если применяется) после обновления зависимостей.
5. Согласовать с DevOps обновление инфраструктурных секретов (Vault/Parameter Store) — завести `DATABASE_URL_ADMIN`, `DATABASE_URL_OPS`, `ADMIN_API_KEY` и т. д.
6. Провести dry-run запуска в staging: развернуть public/admin/ops инстансы, проверить маршруты и фича-флаги.

## Задачи по инфраструктурной подготовке

### Очередность выполнения
1. **INFRA-1: обновление переменных окружения** — подготавливаем `.env` и документацию, чтобы остальные задачи могли опираться на единые переменные.
2. **INFRA-1a: шаблоны контуров в доменах** — создаём пустые подпакеты `api/{public,admin,ops}` и базовые файлы, чтобы фабрика приложения могла подключать готовые модули.
   - [x] Подготовлены подпакеты `api/public`, `api/admin`, `api/ops` (по необходимости) в доменах платформы и продуктов согласно таблице "Новые домены и переименования".
   - [x] Добавлены заглушки `http.py`/`register.py`, обновлены docstring-и пакетов и README домена пользователей с новыми путями.
3. **INFRA-2: фабрика приложения и контейнер зависимостей** — реализуем `create_app`, DI и middleware.
   - [x] ??????? `create_app(contour=...)` ???????? public/admin/ops ? ??????????? ?????? ? DI.
   - [x] ????????? middleware `audience`, ??????????? audience/role ??? admin ? ops.
   - [x] ????????? ????? `tests/app/api_gateway/test_contours.py` ??? ???? ???????? ? ???????? middleware.
4. **INFRA-3: docker-compose и Makefile** — добавляем команды запуска для разных контуров.
5. **INFRA-4: CI/CD и тестовые профили** — обновляем pipeline под новую матрицу.
6. **INFRA-5: секреты и настройки инфраструктуры** — заводим ключи и обновляем конфигурации.
7. **INFRA-6: staging dry-run** — завершаем подготовку и тестируем на стенде.

### INFRA-1: обновление переменных окружения
- **DoR:** ADR и этот документ согласованы; перечень переменных утверждён с безопасностью; есть доступ к `apps/backend/.env.example`.
- **DoD:** `.env` и `.env.example` содержат секции для всех контуров; README обновлён; локальный запуск `make run-public` и `make run-admin` читают корректные переменные.
- **Acceptance Criteria:** переменные `APP_CONTOUR`, `DATABASE_URL_<CONTOUR>`, `REDIS_URL_<CONTOUR>`, `FEATURE_FLAG_<CONTOUR>` задокументированы; `make env-check` (если есть) проходит; table `endpoints.md` отражает новые флага.
- **Шаги выполнения:**
  1. Дополнить `.env.example` и `apps/backend/.env` новыми переменными.
  2. Обновить `apps/backend/README.md` с инструкциями по установке переменных.
  3. Проверить запуск публичного и админского контуров локально (без Docker).
  4. Отметить обновления в `findings.md`, если выявлены риски конфигурации.

### INFRA-1a: шаблоны контуров в доменах
- **DoR:** Структура подпакетов `api/{public,admin,ops}` согласована; список доменов определён в этом документе.
- **DoD:** В целевых доменах созданы `api/public/__init__.py`, `api/admin/__init__.py`, при необходимости `api/ops/__init__.py`, а также базовые `http.py`/`register.py` с заглушками.
- **Acceptance Criteria:** фабрика приложения (INFRA-2) может подключать пустые роутеры без ошибок; README для доменов (при наличии) содержит ссылку на новое расположение.
- **Шаги выполнения:**
  1. Создать подпакеты и файлы-заглушки в доменах, указанных в разделе «Новые домены и переименования».
  2. Добавить минимальные комментарии/докстринги, чтобы описать назначение пакета.
  3. Обновить `findings.md`, если обнаружены домены без чёткого разделения.
  4. Согласовать с владельцами доменов готовность к миграции.

### INFRA-2: фабрика приложения и контейнер зависимостей
- **DoR:** Определена цельная структура регистраторов (public/admin/ops); согласован план миграции модулей.
- **DoD:** `app/api_gateway/main.py`, `container_registry.py`, `wires.py` поддерживают выбор контура из env; unit-тесты/интеграционные тесты проходят.
- **Acceptance Criteria:** вызов `create_app(contour="admin")` монтирует только админские роуты; middleware `audience` активирован; тесты `tests/app/api_gateway` покрывают все варианты.
- **Шаги выполнения:**
  1. Реализовать фабрику `create_app(contour: str)` и обновить точки входа.
  2. Расширить DI, чтобы конструкторы сервисов опирались на выбранный контур.
  3. Добавить/обновить тесты для каждого контура.
  4. Обновить документацию (`pre-migration-actions.md`, если требуется уточнение).

### INFRA-3: docker-compose и Makefile
- [x] `make run-public` — локальный запуск контура `public` из корня репозитория (ожидает ручной проверки).
- [x] `make run-admin` — локальный запуск контура `admin` из корня репозитория (ожидает ручной проверки).
- [x] `make run-ops` — локальный запуск контура `ops` из корня репозитория (ожидает ручной проверки).
- **DoR:** Доступны текущие `docker-compose.yml`, `Makefile`; известны порты и зависимости сервисов.
- **DoD:** Композиция поднимает `backend-public`, `backend-admin`, `backend-ops`; Makefile содержит цели `run-public`, `run-admin`, `run-ops`; smoke-тесты проходят.
- **Acceptance Criteria:** `docker compose --profile local up backend-admin` стартует сервис без ручных правок; `make run-admin` запускает нужный контур; документация обновлена.
- **Шаги выполнения:**
  1. Добавить сервисы контуров в `docker-compose.yml` с уникальными env.
  2. Создать цели Makefile с передачей env и вызовом `uvicorn`.
  3. Протестировать локальный запуск с PostgreSQL/Redis.
  4. Обновить README и этот документ ссылками на команды запуска.

#### Осталось сделать по INFRA-3
- [x] Ручная проверка команд `make run-{public,admin,ops}` и фиксация результата (2025-10-19: локально проверены public/admin/ops, сервисы стартуют на 8010/8011/8012).
- [x] Дополнить ADR curl-примерами при необходимости (`docs/adr-api-segmentation.md`).
- [x] Оставить комментарий в задаче с итогами smoke-прогонов и ссылкой на обновлённые документы (INFRA-3 обновлена в трекере, ссылка приложена).

#### Подготовительные задачи перед INFRA-3

- **TASK-3.1: Подготовить многоконтурные сервисы в docker-compose**
  - **DoR:** (a) Доступны `docker-compose.yml` и `.env`; (b) согласованы порты и профили для local/dev; (c) уточнен набор env (`APP_API_CONTOUR`, `APP_PORT`).
  - **DoD:** В файле описаны сервисы `backend-public`, `backend-admin`, `backend-ops` с уникальными портами, профилями и зависимостями; `docker compose config` проходит без ошибок; назначение сервисов задокументировано.
  - **Acceptance Criteria:** (1) `docker compose --profile local up backend-public` стартует публичный контур без правок; (2) `docker compose --profile local ps` показывает три сервиса с разными портами; (3) комментарии/README объясняют различия контуров.
  - **Шаги:** (1) Скопировать текущий сервис API и завести три экземпляра с именами `backend-{public,admin,ops}`; (2) настроить переменные окружения и порты; (3) обновить `depends_on`/`profiles`; (4) выполнить `docker compose config`.
    - [x] В `docker-compose.yml` добавлены `backend-public`, `backend-admin`, `backend-ops` (порты 8010/8011/8012, профили `local` и `dev`) на основе общего блока `x-backend-defaults` с зависимостями от `postgres`, `redis`, `minio`.
    - [x] Настроен вспомогательный сервис `backend-ci` (профиль `test`) для запуска `make lint typecheck test`, чтобы сохранить прежний сценарий CI.
    - [x] Создан базовый `Dockerfile`, который устанавливает зависимости из `apps/backend/requirements.txt` и готовит окружение Python/uvicorn для контуров.
    - [x] В `.env`, `apps/backend/.env` и `.env.example` добавлены `APP_API_CONTOUR`, `APP_PORT`, `UVICORN_HOST`; команда `docker compose --profile local config` проходит без ошибок.

  - **TASK-3.2: Добавить контурные цели в Makefile (`run-public`, `run-admin`, `run-ops`)**
    - **DoR:** (a) определены локальные порты; (b) известны значения `APP_API_CONTOUR` и `APP_PORT`; (c) согласована команда запуска `uvicorn`.
  - **DoD:** В `apps/backend/Makefile` появились три цели для запуска контуров, каждая выставляет env и стартует сервис; цель `run` делегирует или помечена как legacy; команды корректно завершаются.
  - **Acceptance Criteria:** (1) `make run-admin` запускает API на выбранном порту с контуром `admin`; (2) в логах видно сообщение о выбранном контуре; (3) остановка по `Ctrl+C` завершает процесс без зомби-процессов.
  - **Шаги:** (1) Завести общие переменные (`APP_API_CONTOUR`, `APP_PORT`, `UVICORN_HOST/PORT`); (2) добавить три цели с единым рецептом запуска; (3) вручную проверить каждую команду; (4) обновить раздел помощи/комментарии.
    - [x] Общие переменные окружения добавлены в `apps/backend/Makefile`.
    - [x] Цели `run-public`, `run-admin`, `run-ops` используют макрос `run_contour`.
    - [ ] Ручной прогон `make run-{public,admin,ops}` (ожидает).
    - [x] README и раздел помощи дополнены ссылками на `make run-*`.

- **TASK-3.3: Smoke-валидация и документация по запуску контуров**
  - **DoR:** (a) Tasks 3.1–3.2 закрыты; (b) готов список smoke-тестов (`tests/integration/test_api_gateway_smoke.py`, `tests/app/api_gateway/test_contours.py`); (c) в README выделен раздел “Локальный запуск”.
  - **DoD:** Smoke-тесты успешно пройдены для всех контуров; README и `pre-migration-actions.md` обновлены ссылками на новые команды; при необходимости добавлены примеры curl.
  - **Acceptance Criteria:** (1) `python -m pytest tests/app/api_gateway/test_contours.py` проходит для `APP_API_CONTOUR` = public/admin/ops; (2) README содержит инструкции `docker compose … backend-admin` и `make run-admin`; (3) в данном документе отмечены чекбоксы INFRA-3 с ссылками на команды.
  - **Шаги:** (1) Прогнать smoke и зафиксировать команды запуска; (2) обновить документацию и ADR при необходимости; (3) отметить результаты в `findings.md` или комментарии к задаче.
    - [x] `python -m pytest tests/app/api_gateway/test_contours.py` c `APP_API_CONTOUR` = public/admin/ops (см. раздел «Проверки» в findings).
    - [ ] Дополнительно уточнить ADR + curl-примеры при необходимости.
    - [ ] Зафиксировать результаты в комментариях к задаче.

### INFRA-4: CI/CD и тестовые профили
- **DoR:** Согласована стратегия тестирования; доступен файл pipeline (например, `.github/workflows/ci.yml`).
- **DoD:** Pipeline CI содержит матрицу по контурам; `pytest`/smoke-тесты выполняются для каждого варианта; артефакты логов сохраняются.
- **Acceptance Criteria:** три независимых прогонов тестов (public, admin, ops) завершаются успешно; падение одного не блокирует остальные; обновлён инструктаж в `CodeValidator.md` (если используется).
- **Шаги выполнения:**
  1. Обновить конфигурацию CI: добавить матрицу `contour`.
  2. Настроить шаги `pytest`, `lint`, `smoke` c передачей env.
  3. Проверить работу на ветке с тестовым коммитом.
  4. Зафиксировать изменения в документации по процессу (например, `CodeValidator.md`).

- [x] `.github/workflows/ci.yml` разбит на джобы `backend-quality`, `backend-contour-smoke`, `frontend-quality`; для smoke-тестов добавлена матрица `contour: [public, admin, ops]` с `fail-fast: false` и переменной `APP_API_CONTOUR`.
- [x] `tests/app/api_gateway/test_contours.py` запускается для каждого контура; результаты сохраняются в `pytest-<contour>.xml/.log` и публикуются артефактами GitHub Actions.
- [ ] Smoke-запуск на тестовой ветке и проверка артефактов.
- [x] Обновить `CodeValidator.md` описанием новых этапов CI и ссылкой на логи.

### INFRA-5: секреты и настройки инфраструктуры
- **DoR:** У DevOps есть список требуемых секретов; согласован способ хранения (Vault, Parameter Store).
- **DoD:** Созданы секреты `DATABASE_URL_ADMIN`, `DATABASE_URL_OPS`, `ADMIN_API_KEY`, `OPS_API_KEY`; обновлены политики доступа; конфигурация CI/инфры указывает на новые ключи; разработчики используют локальную конфигурацию (`.env` или `.env.local`) с безопасными заглушками.
- **Acceptance Criteria:** доступ к секретам ограничен; аудит фиксирует создание/изменение; локальные файлы окружения не содержат production-секретов; инструкция по загрузке переменных (через `.env`/`.env.local`) зафиксирована в репозитории.
- **Шаги выполнения:**
  0. Подготовить локальный файл (`apps/backend/.env` или `apps/backend/.env.local`, уже в `.gitignore`) и задокументировать базовые заглушки (`DATABASE_URL_ADMIN=postgresql://postgres:postgres@localhost:5432/app_admin`, `ADMIN_API_KEY=dev-admin-key`, `APP_OPS_API_KEY=dev-ops-key` и т. п.) для разработки. JWT секрет (`APP_AUTH_JWT_SECRET`) хранится отдельно и не совпадает с API-ключами.
  1. Подготовить запрос DevOps с перечнем секретов и требованиями (черновик: `docs/api-inventory/infra-5-devops-ticket.md`).
  2. Совместно с DevOps завести секреты и настроить права.
  3. Обновить конфигурацию CI/deployment, чтобы она брала значения из секретов.
  4. Описать процедуру в playbook (`docs/api-inventory/secret-playbook.md`) и приложить пример команд `gh secret set <NAME> --app actions`.

> Локальный запуск через `make run-<contour>` или `docker compose` может считывать переменные из `.env` либо подмешивать `.env.local` (через `dotenv -f ...`, `direnv` или `python-dotenv`). Важно не размещать production-значения в локальных файлах; для них используются только GitHub Secrets/Vault. Для выгрузки значений из Vault используем `python scripts/vault_export_env.py <path> --map ... --output apps/backend/.env.local`.

### INFRA-6: staging dry-run
- **DoR:** Все предыдущие задачи выполнены; staging-окружение готово; есть план тестов.
- **DoD:** На staging развернуты три контура; проведены smoke-тесты; собраны метрики latency и ошибок; выявленные проблемы оформлены задачами.
- **Acceptance Criteria:** public/admin/ops отвечают корректно; фича-флаги управляются централизованно; отчёт о dry-run приложен в `findings.md`.
- **Шаги выполнения:**
  1. Запустить деплой обновлённого бэкенда на staging.
  2. Пройти чек-лист smoke-тестов и сценариев авторизации.
  3. Снять метрики и логгирование, подтвердить наличие алертов.
  4. Сформировать отчёт, оформить follow-up задачи.

## Управление задачами

### Эпики (по контурам/доменам)

- **DoR эпика**:  
  - ADR согласован и обновлён.  
  - Имеется актуальная диаграмма и таблица эндпоинтов с пометкой контура и приоритетов.  
  - Определены зависитмости от других команд (Security, DevOps) и формы синхронизации.  
  - Подготовлены шаблоны задач с DoR/DoD/AC.

- **DoD эпика**:  
  - Все связанные задачи выполнены и прошли ревью.  
  - Обновлена документация (endpoints, ADR, playbooks).  
  - Смоук- и интеграционные тесты контура зелёные.  
  - Фича-флаг включён в целевом окружении и наблюдаемость подключена.

- **Acceptance Criteria эпика** (пример):  
  1. Все эндпоинты домена обслуживаются соответствующим контуром.  
  2. Middleware проверки `audience/role` включён и покрыт тестами.  
  3. Для административных операций задействованы отдельные креды БД.  
  4. Алерты и дашборды для ключевых операций настроены и протестированы.

### Задачи (разовое изменение)

- **DoR задачи**:  
  - Описаны входные данные (какие файлы/модули затрагиваются).  
  - Определены тесты, которые надо прогнать.  
  - Есть план отката или указание, что изменения обратимы через feature flag.  
  - Указаны зависимые задачи, если есть.

- **DoD задачи**:  
  - Код и тесты смёржены, линтеры/CI зелёные.  
  - Обновлена документация по изменённым ручкам.  
  - Добавлены новые тесты/фикстуры, если логика расширена.  
  - Результаты отражены в `docs/api-inventory/findings.md` (если обнаружены риски) или отмечены как «решено».

- **Acceptance Criteria задачи** (пример для переноса ручки):  
  1. Новый роутер зарегистрирован в соответствующем регистраторе (`register_admin()` и т. п.).  
  2. Middleware `audience/role` не пропускает неавторизованных клиентов (тест positive/negative).  
  3. Диаграмма и таблица эндпоинтов обновлены.  
  4. Фича-флаг установлен в режим `dark launch` или полностью включён в зависимости от стадии.

### Формат постановки задач

- Эпики: `SEGMENT-{N}: <домен> — перенос в <контур>` (пример: `SEGMENT-12: platform.moderation — перенос в Admin API`).  
- Задачи: `SEGMENT-{N}-{suffix}: <ручка/модуль>` (пример: `SEGMENT-12-A: перенести /api/moderation/reports`).  
- В описании включаем ссылки на ADR, этот документ и таблицу эндпоинтов.  
- Чек-листы внутри задач повторяют DoR/DoD/AC для удобства трекинга.

## Обновляемые артефакты

| Артефакт | Кто обновляет | Когда |
|----------|----------------|-------|
| `docs/api-inventory/endpoints.md` | Исполнитель задачи | После каждого переноса ручек |
| `docs/api-inventory/findings.md` | Исполнитель/ревьюер | При обнаружении рисков или после их закрытия |
| `docs/adr-api-segmentation.md` | Архитектор/тимлид | После завершения значимого этапа или изменения подхода |
| Дашборды наблюдаемости | DevOps | Перед включением фича-флага |

Используйте данный документ как контрольный список в рамках подготовки и планирования разработки по сегментации API.

