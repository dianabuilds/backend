# Раздел “Генерация квестов ИИ” — спецификация

Цель
- Дать администраторам и контент‑менеджерам инструмент для генерации, проверки и публикации ИИ‑квестов через API провайдеров LLM.
- Сократить время на подготовку контента, стандартизировать проверку качества и снизить долю ручной рутины.

Роли
- Администратор: доступ ко всем операциям, настройкам, публикации и автофиксам.
- Контент‑редактор: запуск генераций, предварительная модерация, инициирование публикации.
- Наблюдатель (опционально): просмотр статуса задач без права изменений.

Глоссарий
- Шаблон мира (World Template): заготовка сеттинга (правила мира, лор, лексикон).
- Структура: тип повествования — linear / vn_branching (ветвящийся VN) / epic (длинный).
- Длина: short (10–15 глав) / long (40–100 глав) — ориентиры для генерации.
- Тональность: светлый / тёмный / ироничный (набор пресетов).
- Жанр повествования: литературный стиль (например, фэнтези, sci‑fi, нуар и т. п.).
- Задача генерации (Job): единица работы в очереди с жизненным циклом.

## Пользовательские сценарии (UX)

1) Создание ИИ‑квеста
- Кнопка: “Создать ИИ‑квест”.
- Форма:
  - Выбор Шаблона мира (список World Templates).
  - Структура: linear | vn_branching | epic.
  - Длина: short(10–15) | long(40–100).
  - Тональность: светлый | тёмный | ироничный.
  - Жанр/стиль: выпадающий список + поле “свой вариант”.
  - Доп. параметры (опционально): целевая аудитория, допустимые темы/табу, ограничения (объём главы, допустимые ветвления).
- Кнопка “Сгенерировать”:
  - Создаёт Job (status=queued), помещает в очередь.
  - В таблице квестов появляется запись со статусом draft/validating (см. ниже), связанная с Job.

2) Таблица квестов (как сейчас, плюс)
- Поля: название, статус (draft/validating/failed/published), дата создания, автор, тип (short/long), структура, шаблон мира, тональность, жанр, “стоимость генерации” (cost).
- Фильтры: статус, дата, тип (short/long), структура, шаблон мира, автор, текстовый поиск.
- Действия по строке: открыть редактор, открыть отчёт валидации, запустить автофиксы, опубликовать/отклонить.

3) Просмотр/редактирование квеста
- Редактор квестов (повторно используем текущий), синхронизированный со структурами (линейная/ветвящаяся).
- История изменений/версии (минимум — зафиксировать момент публикации).

4) Валидация
- Блок отчёта: ошибки и предупреждения, категории:
  - Структура: повреждённые связи, циклы там, где их быть не должно (для linear), несоответствие количеству глав.
  - Достижимость: есть ли хотя бы одна достижимая концовка; нет ли “ловушек”.
  - Контент: пустые главы, превышение длины, запрещённые темы (при включённых политиках).
- Кнопки авто‑фиксов:
  - “Пометить концовки как end”, “Удалить/починить битые связи”, “Сжать слишком длинные главы” и т. п.
- Правила публикации:
  - При наличии ошибок — публиковать нельзя.
  - При наличии предупреждений — можно публиковать с предупреждением.

5) Публикация
- Кнопка “Опубликовать”.
- Настройки доступа: premium_only | everyone | early_access.
- Обложка (upload) и стиль отображения (фон, пресеты).
- Подтверждение: после публикации создаётся “замороженная” версия (immutable) для игроков.
- Возможность отзыва публикации: создаёт новую черновую версию для правок (старая остаётся как опубликованная версия).

## Модель данных (добавления)

- Quest:
  - structure: enum [linear|vn_branching|epic]
  - length: enum [short|long]
  - tone: enum [light|dark|ironic]
  - genre: string
  - world_template_id: UUID (nullable)
  - status: enum [draft|validating|failed|published]
  - cost_generation: decimal(…)/float (nullable) — стоимость генерации
  - published_version_id: UUID (nullable)
  - cover_url, style_preset (nullable)

- WorldTemplate:
  - id, title, summary, system_prompt, constraints, locale, tags…

- GenerationJob:
  - id, quest_id (nullable пока не создан), status [queued|running|failed|completed|canceled]
  - provider: string (например, openai/anthropic/…)
  - model: string
  - params: jsonb (world_template_id, structure, length, tone, genre, и др.)
  - result_ref: { quest_id, version_id } (jsonb) / отдельные поля
  - cost: decimal/float (итоговая стоимость)
  - token_usage: jsonb { prompt_tokens, completion_tokens }
  - error: text (nullable)
  - created_at, started_at, finished_at, created_by (user_id)

- ValidationReport:
  - id, quest_id, job_id(nullable), level [error|warning|info], code (e.g. link_broken, no_endings), payload(json), created_at
  - aggregated_status per quest (errors_count, warnings_count)

- AutofixAction:
  - id, quest_id, type [mark_endings|remove_broken_links|compress_long_nodes|…], status [applied|skipped|failed], report(json), created_at

## API (черновик)

Админские:
- GET /admin/ai/quests/templates
  - Список World Templates (id, title, tags).
- POST /admin/ai/quests/generate
  - body: { world_template_id, structure, length, tone, genre, extras? }
  - resp: { job_id }
- GET /admin/ai/quests/jobs?status=&created_by=&… (пагинация)
  - Список задач; для running/failed/… — прогресс/ошибки.
- GET /admin/ai/quests/jobs/{job_id}
  - Детали задачи, ссылки на результат (quest_id/version_id).
- POST /admin/ai/quests/jobs/{job_id}/cancel
- GET /admin/quests?filters…
  - Существующая таблица с расширенными полями и cost_generation.
- GET /admin/quests/{id}/validation
  - Текущий отчёт валидации (агрегированный + список проблем).
- POST /admin/quests/{id}/autofix
  - body: { actions: ["mark_endings","remove_broken_links",…] }
  - resp: список применённых фиксов и дифф.
- POST /admin/quests/{id}/publish
  - body: { access: "premium_only"|"everyone"|"early_access", cover_url?, style_preset? }
- GET /admin/ai/quests/settings (опционально)
  - провайдер/модель по умолчанию, лимиты и т. п.

Публичные/служебные:
- POST /internal/ai/quests/worker/pick
- POST /internal/ai/quests/worker/report
- (Опционально) webhook-и от внешних провайдеров.

Стандарты ответа:
- Единый формат ошибок, request_id, статус Job, trace_id.
- Сильная валидация входных параметров.

## Очередь задач и воркер

- Брокер: Redis (или БД + периодический пулящий воркер).
- Жизненный цикл Job: queued → running → completed | failed | canceled.
- Идемпотентность:
  - idempotency_key на POST /generate (опционально): повторный запрос не создаёт дубликат.
- Повторы:
  - Экспоненциальный бэкофф, лимит попыток, запись error.
- Учёт стоимости:
  - После генерации воркер заполняет token_usage и cost (по тарифам провайдера).
  - cost дублируется в Quest.cost_generation.
- Логи/аудит:
  - Создатель job (created_by), кто публиковал, кто применял автофиксы.

## Валидация

Правила:
- Ошибки (блокируют публикацию):
  - Битые связи/ссылки, отсутствуют доступные концовки.
  - Неконсистентная структура (для linear).
  - Пустые/повреждённые главы.
- Предупреждения:
  - Слишком длинные главы, перекрёстная перегруженность веток, стилистические огрехи.
  - Несоответствие целевому диапазону главы/длины.
- Автофиксы:
  - mark_endings — проставить end, если явно достижимые финалы не отмечены.
  - remove_broken_links — удаление/чинка ссылок.
  - compress_long_nodes — попытка сокращения (через LLM-перефразирование).
  - normalize_metadata — привести поля к стандарту.

Правила публикации:
- При errors_count > 0 запрещать публикацию (HTTP 409 + список ошибок).
- При warnings_count > 0 — разрешать, но показывать баннер с предупреждением.

## Публикация и версии

- publish создаёт неизменяемую версию для игроков.
- В таблице квестов: статус published и ссылка на published_version_id.
- Отзыв публикации создаёт новый draft (копия с bump версией), старая версия остаётся для истории.

## UI/UX (админка)

1) Список квестов:
- Колонки: Название, Статус, Тип (short/long), Структура, Мир, Тональность, Жанр, Автор, Стоимость, Создан, Действия.
- Фильтры: статус, дата, тип, структура, шаблон мира, автор, поиск.
- Действия: Открыть, Валидация, Автофиксы, Публикация, Удалить (по ролям).

2) Создание ИИ‑квеста:
- Модал/страница: выбор шаблона мира, структура, длина, тональность, жанр + “Сгенерировать”.
- Показать статус Job: queued/running с прогрессом и ссылкой на лог.

3) Страница квеста:
- Редактор контента (как сейчас).
- Панель статуса: отчёт валидации (ошибки/варнинги), кнопки автофиксов.
- Блок публикации: выбор доступа (premium_only/everyone/early_access), обложка, стиль, кнопка “Опубликовать”.

4) История/логи:
- Боковая панель: задачи генерации (Job) с временем, провайдером, стоимостью, ссылками на артефакты и diff.

## Права, безопасность, фичефлаги

- Роли: публикация и автофиксы — только admin; генерация — admin+редакторы.
- Feature flags:
  - ai.quests.enabled — включает раздел.
  - ai.quests.autofix — включает автофиксы.
  - ai.quests.publish — включает публикацию.
- Rate limiting: на создание Job (пер‑пользователь/пер‑организация).
- Контент‑политики: серверная фильтрация запрещённых тем, форс‑валидация.

## Метрики и мониторинг

- Количество созданных Job, доля failed, средняя задержка до completed.
- Средняя/медианная стоимость на квест, стоимость в разрезе параметров (структура/длина/мир).
- Конверсия draft → published, число автофиксов, среднее количество ошибок/предупреждений.

## План внедрения (итерации)

1) MVP:
- Форма генерации → очередь → базовый воркер → черновой квест.
- Базовая валидация и запрет публикации при ошибках.
- Публикация с доступом и обложкой.
- Метрики Job и cost.

2) Улучшения:
- Автофиксы (mark_endings/remove_broken_links).
- Детализированный отчёт валидации, категории, якорные ссылки на проблемные узлы.
- Расширенные фильтры и сортировки в списке.

3) Масштабирование:
- Параллельные воркеры, приоритезация, ограничение по проекту.
- Тонкая настройка подсказок (prompt engineering), пресеты “тональности/жанра”.

## Примеры запросов

POST /admin/ai/quests/generate
