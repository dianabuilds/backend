# Проверка зависимостей фронтенда

Документ описывает, как контролировать импорт между слоями фронтенда и поддерживать актуальные отчёты без хранения разовых логов.

## Назначение
- удерживать границы между `layout → pages → widgets/features → entities/shared`;
- быстро находить циклические зависимости и импорты «вверх» по слоям;
- обеспечить одинаковые команды для локальных и CI-проверок.

## Подготовка
- Node.js >= 18, установленный pnpm/npm (используем npm по умолчанию).
- Выполнены `npm install` и `npm run build` в `apps/web` хотя бы один раз (для корректности aliasов).
- В каталоге `scripts/` доступен `analyze-frontend-deps.mjs`.

## Быстрая проверка
Используется в спринтовых проверках и на CI.
```bash
cd apps/web
npm run lint:deps  # запускает скрипт в режиме --check
```
Команда завершится ошибкой, если найдены запрещённые импорты или новые циклы. Отчёты не перезаписываются.

## Полное обновление отчётов
Запускаем перед плановым аудитом или большой миграцией.
```bash
cd apps/web
node scripts/analyze-frontend-deps.mjs
```
Скрипт генерирует JSON-файлы в `var/frontend-deps/`:
- `dependency-edges.json` — полный список импортов;
- `layer-matrix.json` — агрегированная матрица слоёв;
- `violations.json` — конкретные нарушения (если есть).

Файлы не коммитим как артефакты аудита: храним последнюю версию для справки. Если нужен исторический отчёт, сохраняем его в `reports/frontend-deps/<дата>.md` и ссылаемся из таска.

## Интерпретация результатов
- **Импорты вверх по слоям** (`features → pages`, `shared → pages`) блокируют merge. Исправляем, вынося общие части в `shared` или разделяя widgets.
- **Импорты в `internal/`** допустимы только для тестов или временных миграций. Наличие в продовом коде считается нарушением.
- **CSS/asset-файлы** исключены из анализа. Если зависимость касается стилей, проверяем её вручную.
- **Циклы** отображаются отдельным списком; предпочтительно разрывать их через выделение интерфейсов или общих утилит.

## Когда запускать
- перед рефакторингом слоёв и созданием новых layout'ов;
- после массового перемещения файлов или переименования директив импорта;
- перед релизом крупных фич, чтобы убедиться, что нет скрытых связей.

## Интеграция с другими документами
- Любые изменения в правилах слойности синхронизируем с `./layering.md`.
- Если найденные нарушения требуют архитектурных решений, фиксируем их в ADR или создаём отдельный раздел в `../playbooks/code-audit.md`.
