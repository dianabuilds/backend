# Плейбук аудита кодовой базы

Документ описывает базовые правила технического аудита монорепозитория. Он заменяет временные «волны» задач и служит опорой для регулярных ревизий кода без привязки к конкретным датам.

## Назначение
- поддерживать прозрачный список обязательных проверок перед релизами и крупными рефакторингами;
- синхронизировать команды фронтенда, бэкенда и инфраструктуры вокруг единых критериев качества;
- фиксировать, куда сохраняются артефакты аудита и кто отвечает за обновление сопутствующих документов.

## Охват
- **Фронтенд** — слойность, производительность, UX/доступность.
- **Бэкенд** — доменные границы, типизация, безопасность, производительность API.
- **Инфраструктура** — CI/CD, статический анализ, управление секретами и зависимостями.

## Ритм аудита
- **Раз в спринт** — быстрые проверки (линтеры, типы, зависимые сборки, импорт-правила).
- **Ежемесячно** — расширенный аудит (профилирование горячих сценариев, Lighthouse, importlinter, ревью миграций).
- **Перед релизом фичи** — точечный аудит задействованных модулей и обновление runbook'ов.

## Контрольные направления
| Направление | Что проверяем | Инструменты/скрипты |
|-------------|---------------|----------------------|
| Фронтенд | слои, размер стартового чанка, Lighthouse | `npm run lint:deps`, `node scripts/analyze-frontend-deps.mjs`, `npm run build && npm run preview`, `npx lighthouse` |
| Бэкенд | типизация, импорт-границы, smoke-тесты API | `scripts/validate_repo.py`, `python -m importlinter.cli lint --config apps/backend/importlinter.ini`, `pytest -c apps/backend/pytest.ini` |
| Инфраструктура | зависимые артефакты, SBOM, секьюрити | `scripts/validate_repo.py`, `cyclonedx`, `pip-audit`, ревью `.github/workflows/*.yml` |

## Целевые метрики качества
| Метрика | Цель | Где фиксируется |
|---------|------|-----------------|
| Lighthouse (mobile) | >= 85 performance, >= 95 SEO | отчёты в `var/lighthouse-<page>.json` |
| Покрытие pytest | >= 85% по критичным доменам | `reports/pytest/coverage.xml` |
| Mypy strict | 0 ошибок в включённых пакетах | `mypy.log` |
| Время CI PR | <= 10 минут | вкладка GitHub Actions |
| Импорт-границы | 0 нарушений контрактов | `var/backend-import-lint.txt`, `var/frontend-deps/violations.json` |

## Как проводить аудит
1. **Подготовить окружение**  
   - Установить зависимости (`pip install -r apps/backend/requirements.txt`, `npm install`).  
   - Обновить фикстуры или переменные окружения, необходимые для smoke-тестов и профилирования.
2. **Собрать быстрые проверки**  
   - Запустить `scripts/validate_repo.py`.  
   - Выполнить `npm run lint`, `npm run lint:deps`, `python -m importlinter.cli lint --config apps/backend/importlinter.ini`.
3. **Снять метрики**  
   - Сформировать SBOM (`cyclonedx`).  
   - Снять Lighthouse и Frontend bundle report (`npm run build && npm run preview`, затем `npx lighthouse ...`, `npm run build -- --report`).  
   - Прогнать `pytest -c apps/backend/pytest.ini --cov` и сохранить отчёты.  
   - При необходимости запустить `scripts/api_benchmark.py` и профилировщики из `docs/performance-playbook.md`.
4. **Разобрать результаты**  
   - Зафиксировать нарушения и необходимые действия в таск-трекере.  
   - Обновить тематические документы (например, `docs/frontend-dependency-report.md`, `docs/performance-playbook.md`, `apps/backend/ARCHITECTURE.md`).

## Хранение артефактов
- Сырые отчёты и профили складываем в `var/<context>/` или `reports/<context>/`.  
- В документации указываем путь и дату обновления, но не вставляем длинные логи.  
- Репозиторий не хранит бинарные артефакты размером >10 MB; для них используем внешние хранилища или артефакты CI.

## Ответственность
- **Владельцы доменов** — актуальность гайдлайнов, описание API и тестов.  
- **Инфраструктура** — поддержка скриптов (`scripts/*.py`, GitHub Actions).  
- **Команды фич** — фиксация метрик перед релизом и обновление узконаправленных runbook'ов.

## Связанные документы
- `docs/frontend-dependency-report.md` — правила анализа импортов фронтенда.  
- `docs/frontend-layer-migration-plan.md` — гайд по слойности и миграциям UI.  
- `docs/performance-playbook.md` — про профилирование и хранение метрик.  
- `docs/backend-testing-strategy.md` — единый подход к тестам.  
- `docs/security-requirements.md` — требования к защите API и хранению секретов.
