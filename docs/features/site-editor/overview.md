# Site Editor — ядро модели блоков и страниц

Документ описывает единственную актуальную модель редактора сайта. Все остальные заметки удалены; при изменениях обновляйте этот файл.

## 1. Сущность `Block`

`site_blocks` хранит любые блоки: глобальные, шаблонные («рыбы») и страничные копии. У блока один набор полей:

| Поле | Назначение |
|------|------------|
| `id` (`uuid`) | первичный ключ |
| `title` (`text`) | имя для редактора |
| `scope` (`shared` \| `page`) | использует ли блок сразу несколько страниц или принадлежит одной |
| `is_template` (`boolean`) | блок служит заготовкой; не публикуется напрямую |
| `origin_block_id` (`uuid`, nullable) | из какого шаблона скопирован `scope='page'` блок |
| `section` (`text`) | слот страницы (`header`, `hero`, `content`, `footer`, …) |
| `status` (`draft` \| `published` \| `archived`) | текущее состояние |
| `version` (`bigint`) | номер опубликованной версии |
| `data` (`jsonb`) | полезная нагрузка. Обязательные поля описаны JSON Schema компонента. Данные локализуются по ключу локали: `data.title.ru`, `data.title.en`, и т.д. |
| `meta` (`jsonb`) | служебные флаги (`{"owners": [...], "schedule": {...}}`). Без произвольных ключей. |
| `created_at / created_by`, `updated_at / updated_by` | аудит |

### Локализация данных

- Значения в `data` хранятся как словарь `locale → payload`. Компонент на странице читает только текущее значение (`ru` для RU‑страницы, `en` для EN‑страницы).
- Если для обязательного поля нет значения соответствующей локали, блок считается «не готов к публикации».
- Допускается разное количество элементов в локалях (например, в EN-версии меню может быть больше пунктов, чем в RU).

### Публикация

- Черновик правится в `data`/`meta`. При публикации увеличивается `version` и пишется снапшот в `site_block_versions` (`block_id`, `version`, `data`, `meta`, `published_at/by`).
- `is_template=true` блоки обновляют только будущие копии. Для страницы создаётся новый блок с `scope='page'`, `origin_block_id=<template id>`, статусом `draft`.
- Shared-блоки (`scope='shared'`) применяются сразу во всех привязках; перед публикацией проверяем локализации.

## 2. Библиотека блоков

- Список строится по `site_blocks`. Фильтры: `scope`, `status`, `is_template`, `section`, `locale_ready` (показывает, какие локали заполнены).
- Карточка блока показывает: статус, scope, признак «рыба», локали, дату/автора обновления, кнопки «Редактировать», «Предпросмотр», «Сохранить», «Опубликовать», «Архивировать».
- Редактирование открывает форму, основанную на JSON Schema компонента. Локали переключаются табами; без перевода публикация запрещена.
- Действие «Использовать на странице» создаёт копию блока (`scope='page'`, `origin_block_id` заполняется, `status=draft`) и сразу привязывает её к выбранной странице/секции.

## 3. Привязки блоков к страницам

Таблица `site_block_bindings` хранит фактическое размещение блоков:

| Поле | Назначение |
|------|------------|
| `page_id` (`uuid`) | страница |
| `block_id` (`uuid`) | блок |
| `section` (`text`) | слот на странице |
| `position` (`integer`) | порядок в секции |
| `locale` (`text`, nullable) | если заполнено — блок используется только в этой локали; `NULL` = общий блок для всех локалей |
| `is_draft` (`boolean`) | черновой порядок отличается от опубликованного |
| `content_version` (`bigint`) | с какой версией блока собрана опубликованная страница |
| `created_at`, `updated_at` | аудит |

Публикация страницы:

1. Проверяет, что для каждого привязанного блока есть данные по нужной локали.
2. Для `scope='page'` блоков публикует актуальный черновик (увеличивает `version`).
3. Создаёт запись в `site_page_versions` и фиксирует `content_version` в привязках.

## 4. API (минимум)

- `GET /v1/site/blocks` — список блоков с фильтрами; CRUD и публикация работают с одной сущностью.
- `POST /v1/site/blocks { is_template: true }` — создать заготовку.
- `POST /v1/site/pages/{id}/blocks` — создать копию шаблона и привязать её к странице (запрашивается `block_id`, `section`, `position`, `locale?`).
- `GET /v1/site/pages/{id}?locale=ru` — возвращает страницу + блоки, уже отфильтрованные по локали.
- Предпросмотр использует те же данные: собирает блоки по черновым привязкам и возвращает JSON для клиентского SSR.

## 5. Правила гигиены данных

- В `meta` допускаются только согласованные ключи (`owners`, `schedule`, `tags`). Новые поля добавляйте через код-ревью.
- Shared-блоки не могут иметь `is_template=true`. Шаблон *никогда* не привязывается к странице напрямую.
- Если шаблон обновился и нужно протолкнуть изменения на страницы, делайте это осознанно: массовый скрипт создаёт новые копии или вручную редактируются страничные блоки.
- Библиотека отображает статусы локалей: «готово», «не заполнено», «не требуется». Публикация блокирует незаполненные обязательные языки.

---

Это единственный документ, описывающий модель Site Editor. Если требуются дополнительные пояснения (например, по конкретному компоненту), добавляйте разделы сюда или создавайте краткие ADR с ссылкой на этот файл.
