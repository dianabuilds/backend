# План задач: библиотека глобальных блоков

## 1. UX / Продуктовое проектирование
- [x] GB-01 Подготовить UX-макет карточки блока (вкладки «Инфо», «Контент», «Предпросмотр», «JSON», «История», «Метрики»).  
  - **Цель:** зафиксировать структуру интерфейса до начала разработки.  
  - **Действия:** собрать требования, нарисовать макеты в Figma, согласовать с продуктом.  
  - **Артефакты:** текстовый макет зафиксирован в `global-block-guidelines.md` (см. раздел 1.1).
- [x] GB-02 Описать пользовательские сценарии редактирования, предпросмотра, публикации и отката.  
  - **Цель:** чтобы FE/BE понимали пошаговые флоу и роли.  
  - **Действия:** подготовить user-flow диаграммы, описать happy-path и edge-кейсы (например, конфликт версий).  
  - **Артефакты:** сценарии задокументированы в `global-block-guidelines.md` (раздел 3). Для решений по диаграммам можно использовать текущий текст как основу.
- [x] GB-03 Согласовать требования к drag & drop для меню и подменю (primary/secondary/utility/mobile).  
  - **Действия:** описать ограничения (макс. вложенность, лимиты элементов), решить как сохраняются порядки.  
  - **Артефакты:** спецификация в `global-block-guidelines.md` (раздел 4) с примерами ограничений.
- [x] GB-04 Утвердить визуальные вариации (default/compact/mega) и требования к preview (desktop/mobile, светлая/тёмная темы).  
  - **Артефакты:** перечень и чек-лист размещены в `global-block-guidelines.md` (раздел 5); отдельные макеты можно дополнить, опираясь на описание.

## 2. Фронтенд: библиотека блоков
- [ ] GB-10 Реализовать вкладку «Основная информация».  
  - **Включает:** вывод полей из summary, кнопки «Сохранить», «Опубликовать», статусы ревью, отображение прав.  
  - **Готовность:** состояние синхронизируется с API, ошибки показаны в UI.
- [ ] GB-11 Построить форму «Контент» по JSON Schema.  
  - **Действия:** сгенерировать типы, создать формы для логотипов, CTA, настроек layout/features.  
  - **Результат:** изменения мгновенно отражаются в state, проходят клиентскую валидацию.
- [ ] GB-12 Добавить drag & drop и модалки редактирования элементов меню.  
  - **Артефакты:** sortable списки, модалки редактирования элемента, поддержка подменю, клавиатурная навигация.
- [ ] GB-13 Настроить live-валидацию (UI + интеграция с backend-валидатором).  
  - **Результат:** ошибки класса «пустой label», «невалидный href» отображаются рядом с полем, сохраняться нельзя.
- [ ] GB-14 Реализовать вкладку «JSON» как fallback.  
  - **Действия:** редактор кода с подсветкой, автопроверка схемы, синхронизация с формами при переключении.  
  - **Edge-кейсы:** предупреждения при несохранённых изменениях.
- [ ] GB-15 Подключить вкладки «История» и «Метрики».  
  - **История:** запрос `/history`, таблица версий, кнопка «Восстановить».  
  - **Метрики:** графики/таблицы из `/metrics`, фильтры по периоду, обработка ошибок источника.
- [ ] GB-16 Добавить панель зависимостей (использующие страницы).  
  - **Действия:** запрос usage, вывод slug/title/status, бейджи черновиков.  
  - **Результат:** предупреждения, если блок не используется либо есть несохранённые изменения на страницах.

## 3. Общие компоненты предпросмотра
- [ ] GB-20 Вынести визуальные компоненты в пакет `@site-editor/preview`.  
  - **Цель:** единый рендер между редактором и публичным сайтом.  
  - **Артефакты:** story + экспорт компонентов, документация по API компонента.
- [ ] GB-21 Реализовать live preview внутри карточки.  
  - **Действия:** связать форму с компонентом, поддержать layout’ы и темы, отображать состояние загрузки/ошибок.  
  - **Результат:** изменения в форме моментально видны.
- [ ] GB-22 Добавить переключатель локалей и вариантов.  
  - **Артефакты:** UI переключения, валидация наличия локалей, fallback при отсутствии данных.

## 4. Бэкенд и API
- [ ] GB-30 Актуализировать JSON Schema глобальных блоков.  
  - **Действия:** расширить схему новыми полями (подменю, иконки, флаги), обновить версии.  
  - **Результат:** схемы покрывают требования формы и проходят проверку в CI.
- [ ] GB-31 Проверить/обновить endpoint’ы сохранения и публикации.  
  - **Действия:** добавить валидацию новых полей, вернуть расширенный объект блока, обработать конкурирующие сохранения.  
  - **Тесты:** unit + интеграционные.
- [ ] GB-32 Расширить API истории версий и diff.  
  - **Цель:** diff отображает изменения в меню/CTA понятными патчами.  
  - **Действия:** обновить генератор diff, адаптировать сериализацию.
- [ ] GB-33 Проверить синхронизацию `site_global_block_usage`.  
  - **Действия:** адаптировать парсер ссылок к новой структуре, обновить триггеры, покрыть тестами.

## 5. Интеграция с редактором страниц
- [ ] GB-40 Обновить вкладку «Параметры» редактора страницы.  
  - **Действия:** показывать статусы блока, бейдж «Нужен publisher», признак черновика.  
  - **Результат:** редактор видит, что глобальный блок требует публикации.
- [ ] GB-41 Добавить проверки при публикации страницы.  
  - **Цель:** запретить публикацию, если глобальный блок в статусе `draft`/`pending` без подтверждения.  
  - **Действия:** серверные проверки + UI предупреждение.
- [ ] GB-42 Синхронизировать уведомления при публикации глобальных блоков.  
  - **Артефакты:** события Inbox, email-рассылка, баннеры в редакторе страниц.

## 6. Документация и Storybook
- [ ] GB-50 Обновить `block-library.md` (описание глобальных блоков, владельцы, ссылки на макеты).  
  - **Результат:** документ отражает новые UX/формы.
- [ ] GB-51 Подготовить Storybook-истории.  
  - **Действия:** сценарии для всех layout’ов, а также edge-кейсы (пустое меню, длинные labels).  
  - **Требования:** stories синхронизированы с компонентами из `@site-editor/preview`.
- [ ] GB-52 Поддерживать `global-block-guidelines.md` в актуальном состоянии.  
  - **Действия:** обновлять разделы при внедрении новых фич, фиксировать ссылки на макеты/тесты.

## 7. Миграция и тестирование
- [ ] GB-60 Подготовить миграцию текущих конфигов.  
  - **Действия:** анализ существующих JSON, написание скрипта преобразования, тестирование на staging.  
  - **Результат:** все блоки мигрируются без потерь данных.
- [ ] GB-61 Написать unit-тесты валидаторов и адаптеров.  
  - **Покрытие:** корректные кейсы, невалидные ссылки, лимиты элементов.
- [ ] GB-62 Создать интеграционные и e2e-тесты полного сценария.  
  - **Действия:** Cypress/Vitest сценарии «изменить → сохранить → опубликовать → применить на странице → проверить preview».  
  - **Результат:** автоматическая проверка регрессий.
- [ ] GB-63 Настроить алерты при публикации глобального блока.  
  - **Действия:** уведомления владельцам страниц (Inbox/email), логирование в `site_audit_log`, тест рассылки.

## 8. Роли и доступ
- [ ] GB-70 Спроектировать и утвердить новую матрицу ролей (`admin`, `moderator`, `editor`, `support`).  
  - **Действия:** согласовать полномочия (см. `global-block-guidelines.md`, раздел 7), решить, объединяем ли `moderator` и `support`.  
  - **Артефакты:** таблица привилегий, обновлённая документация по ролям.
- [ ] GB-71 Имплементировать модель ролей `user/editor/support/moderator/admin` во всех слоях (RBAC, проверки API, миграция алиасов `site.*`).  
  - **Действия:** добавить роли в БД, обновить декораторы `require_role_db`, пересмотреть тесты.  
  - **Результат:** админка использует новые роли, legacy роли выключены или сопоставлены.
- [ ] GB-72 Обновить frontend-guard’ы и UI (бейджи, доступность действий).  
  - **Действия:** изменить проверки в `SiteBlockLibraryPage`, `SitePageEditor`, скрыть/заблокировать действия для `support`.  
  - **Артефакты:** проверка состояния интерфейса для каждой роли.

> **Примечание:** при добавлении новых типов глобальных блоков расширяйте список задач соответствующими карточками (пример: GB-70 для promo-баннеров). Все задачи синхронизируются с ответственными командами (UX, frontend, backend, QA).
