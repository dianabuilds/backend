# Руководство по редактированию глобальных блоков

Документ описывает процесс работы с глобальными блоками (header, footer, промо-зоны и т.д.) в библиотеке блоков. Используется совместно с `overview.md`, `block-library.md` и API-спецификацией.

## 1. Область ответственности

- **Библиотека блоков** — точка редактирования шаблонов. Здесь настраиваем контент, визуальные варианты, сохраняем и публикуем версии.
- **Редактор страницы** — место применения опубликованных шаблонов. Пользователь выбирает блок для зоны страницы, видит зависимости и публикует итоговый черновик.
- JSON-структуры остаются совместимыми с API (`docs/features/site-editor/api.md`), но UI скрывает работу с «сырым» конфигом за формами и предпросмотром.

### 1.1 UX-макет карточки глобального блока

Карточка состоит из трёх зон:

1. **Header** (sticky). Фон `#F8F9FB`, тень `0 1px 8px rgba(15,23,42,0.08)` появляется при скролле. Содержимое: «← К каталогу», заголовок, бейджи статусов (`Черновик`, `Только publisher`, `Ревью не требуется`), быстрые свойства (Название, Ключ, Зона, Локаль). Справа — действия `Сохранить черновик`, `Опубликовать`, `Обновить данные`.
2. **Рабочая область**. Фон `#EEF1F8`, чтобы белые карточки не сливались с основным фоном. Сетка `grid`:
   - Левая колонка `280px` — краткий summary (комментарий, версия черновика/публикации, права).  
   - Центральная колонка `minmax(0, 920px)` — вкладки с основным контентом. Каждая вкладка — белая карточка с радиусом `24px`, border `1px solid rgba(15,23,42,0.08)`, padding `24px`.
   - Правая колонка `320px` — карточки «Зависимости», «История публикаций», «Метрики блока».
3. **Footer** отсутствует; вместо него используем отступ `48px` после основной карточки.

Вкладки (`Контент`, `Предпросмотр`, `JSON`, `История`, `Метрики`) размещаются в верхней части центральной карточки. Активная вкладка подсвечена цветом `#5B7CFF`, неактивные — `#94A3B8`. При переключении показываем inline loader справа от заголовка. Ошибки/предупреждения отображаются под шапкой вкладки, фоном `#FEE2E2` (ошибка) или `#FEF3C7` (варнинг) с иконкой `AlertTriangle`.

**Адаптивность:**
- `<1280px`: сетка переходит в две колонки, правая панель (зависимости/метрики) уходит под центральную карточку.
- `<960px`: вкладки становятся аккордионами, header остаётся sticky. Внутренние карточки получают фон `#FFFFFF`, а вокруг добавляем полосы `gradient-overlay`, чтобы границы были заметны.

## 2. Структура карточки и вкладок

1. **Основная информация.** Поля summary + действия (статус ревью, комментарии, права). Включает бейджи «Нужен publisher», «Есть черновик», «Требуется ревью».
2. **Контент.** Форма на основе JSON Schema: логотипы (превью), поля CTA, переключатели sticky/hideOnScroll, коллекции меню.
3. **Предпросмотр.** Живой рендер компонентов (desktop/mobile, светлая/тёмная тема, варианты layout). Предусмотреть переключатель локалей.
4. **JSON.** Fallback-редактор с подсветкой, автопроверкой схемы и предупреждением при несохранённых изменениях.
5. **История.** Таблица версий (номер, дата, автор, комментарий), diff, кнопка «Восстановить».
6. **Метрики.** Графики по показам/кликам, статус источника, предупреждения.
7. **Зависимости.** Список страниц, использующих блок (slug, название, статус, владелец, наличие черновика).

## 3. Пользовательские сценарии

### 3.1 Редактирование шаблона
1. Пользователь открывает блок на вкладке «Контент».
2. Вносит изменения (например, добавляет пункт меню). UI валидирует поля и показывает ошибки inline.
3. Переключается на «Предпросмотр», проверяет отображение на desktop/mobile, переключает тему.
4. Сохраняет черновик. В header обновляются версия и бейдж статуса ревью.
5. По необходимости переключается в «История», оставляет комментарий к версии.

### 3.2 Публикация
1. Перед публикацией проверяем панель «Зависимости»: предупреждаем, если блок не используется либо есть страницы с черновиком.
2. Пользователь нажимает «Опубликовать», вводит комментарий. Бэкенд проверяет валидацию и наличие зависимых черновиков.
3. После публикации отправляем уведомления владельцам страниц, создаём запись в `site_audit_log`.

### 3.3 Откат версии
1. Во вкладке «История» пользователь выбирает версию и нажимает «Восстановить».
2. Создаётся новый черновик, diff отображается в карточке.
3. Пользователь при необходимости редактирует контент и повторно публикует.

### 3.4 Просмотр метрик
1. Пользователь открывает карточку справа («Метрики блока»).
2. Выбирает период `1d/7d/30d`, получает данные по показам, кликам, CTR. При ошибке источника показывается предупреждение и время последней удачной выборки.
3. Метрики в истории публикаций привязываются к версиям.

## 4. Требования к drag & drop меню

- Уровни: `primary`, `secondary`, `utility`, `mobile.menu`. Подменю поддерживает только один уровень вложенности (`items[].children[].items`).
- Максимум 12 элементов в группе, 8 элементов в подменю.
- Перетаскивание поддерживает мышь и клавиатуру (`Space` — выбор элемента, `ArrowUp/Down` — перемещение).
- После изменения порядка формируем JSON со стабильными идентификаторами (`id` не перезаписываем).
- В пустых группах отображаем состояние `EmptyState` с кнопкой «Добавить ссылку».
- Валидация: уникальные `id`, валидные `href` (относительные и абсолютные в соответствии со схемой), max длина `label` 48.

## 5. Визуальные вариации и предпросмотр

- Поддерживаем варианты layout: `default`, `compact`, `mega`. В зависимости от варианта используем разные структуры меню (например, mega-menu отображает плитку иконок).
- Предпросмотр должен позволять переключать:
  - layout (селектор);
  - тему (светлая/тёмная);
  - устройство (desktop width 1280, mobile width 390);
  - локаль (если указана `available` в `localization`). При отсутствии данных показываем предупреждение и fallback.
- Предпросмотр рендерит те же React-компоненты, что и публичный сайт (см. пакет `@site-editor/preview`).

## 6. Схемы и переиспользование компонентов

- Каждому глобальному блоку соответствует JSON Schema (`apps/backend/domains/product/site/schema/global_blocks`). Фронтенд импортирует схему для типизации и валидации.
- Компоненты предпросмотра выносятся в общий пакет, чтобы избегать расхождений между редактором и витриной.
- Формы используют общие UI-компоненты: `MenuItemsEditor`, `LogoUploader`, `CtaEditor`.

## 7. Роли и права

### 7.1 Новая модель ролей админки

| Роль | Полномочия | Комментарии |
|------|------------|-------------|
| `admin` | Полный доступ: редактирование, публикация, управление правами, конфигурацией и метриками. | Ограниченный пул аккаунтов, используется для критичных операций. |
| `moderator` | Публикация и откаты, запуск ревью, доступ к метрикам и аудитам. | Фактический «старший редактор» для управляемых публикаций. |
| `editor` | Создание и редактирование черновиков, публикация блоков и страниц в рамках своих зон. | Базовая операционная роль контент-команды. |
| `support` | Просмотр блоков и страниц, заметки и комментарии, помощь командам без изменения структуры. | Поддержка и смежные функции. |
| `user` | Нет доступа к админке. | Работает только с публичным сайтом. |

Старые алиасы `site.*` продолжают распознаваться бэкендом и фронтендом (см. маппинг в `SiteService`), но для всех новых интеграций следует использовать роли `user`, `editor`, `support`, `moderator`, `admin`.

### 7.2 Общие правила

- Все действия (редактирование, публикация, откат, ревью) логируются в `site_audit_log`.
- Если поле `requires_publisher = true`, UI блокирует автопубликацию до подтверждения пользователя с ролью `editor` или выше; по процессу такие блоки обязаны проходить дополнительную проверку/аппрув от `admin`.
- Для `support` доступен режим read-only интерфейса: вкладки остаются кликабельными, но поля недоступны. Предпросмотр работает для проверки инцидентов.

## 8. Связь с редактором страниц

- При сохранении и публикации блоков обновляется `site_global_block_usage`. Панель «Зависимости» в библиотеке показывает slug, статус и владельца каждой страницы.
- В редакторе страниц блоки выбираются во вкладке «Параметры». UI показывает статус выбранного блока, бейдж «Нужно опубликовать», наличие черновика.
- Если блок имеет черновик, публикация страницы требует подтверждения (`acknowledge_usage = true`). UI отображает предупреждение до завершения публикации.

## 9. Документация и Storybook

- Для каждого блока необходимо иметь story в Storybook (варианты layout, крайние случаи).
- В `block-library.md` описываем ссылку на карточку блока, владельцев и специфические правила.
- Этот документ обновляется при изменениях UX или появлении новых типов блоков.

## 10. Следующие задачи

- Реализовать визуальные формы и drag & drop (см. `global-block-task-list.md`).
- Интегрировать live preview и поддержку тем/устройств.
- Выполнить миграцию существующих JSON-конфигов.
- Добавить unit/интеграционные/e2e-тесты.
- Настроить уведомления для владельцев страниц при публикации глобальных блоков.
