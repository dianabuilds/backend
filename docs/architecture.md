# Архитектура

Проект построен на **FastAPI** и использует асинхронный стек:

- **FastAPI** — слой HTTP и маршрутизации.
- **SQLAlchemy 2.0** с `asyncpg` — работа с PostgreSQL.
- **Модели и репозитории** (`app/models`, `app/repositories`) — разделение схем БД и запросов.
- **Движок навигации** (`app/engine`) — выбор следующего узла (компас, echo, random, контроллер режимов).
- **Кеширование** (`app/services/navcache`) — Redis для навигации и компаса.
- **Уведомления** (`app/services/notification_ws`) — WebSocket‑канал и e‑mail через SMTP.
- **Квесты и достижения** (`app/services/quests`, `app/models/achievement`) — прогресс, выдача наград.
- **Платежи** (`app/services/payments`) — проверка токенов и продление премиума.

Слои приложения:

1. **API** (`app/api`) — описывает публичные эндпоинты.
2. **Сервисы** (`app/services`) — бизнес‑логика (почта, квесты, навигация, платежи).
3. **Репозитории** (`app/repositories`) — сложные запросы к БД.
4. **Модели** (`app/models`) — ORM‑описание таблиц.
5. **Схемы** (`app/schemas`) — Pydantic‑модели для валидации.
6. **Core** (`app/core`) — настройки, безопасность, логирование.

Дополнительные компоненты:

- **Embeddings** (`app/engine/embedding.py`) — генерация и обновление вектора pgvector.
- **Уведомления** — push‑канал через WebSocket и e‑mail сервис.
- **Навигационный кеш** — инвалидация при изменении узлов/тегов/переходов.

