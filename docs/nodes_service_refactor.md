# Рефакторинг работы с нодами и связями

Этот документ фиксирует текущее состояние, проблемы и план перехода к более консистентной и разделённой архитектуре для операций над нодами/связями.

## Оценки (0–100)

- Консистентность реализации (повторное использование, одинаковые правила): **62/100**
- Соответствие SRP (тонкие контроллеры, логика в сервисах): **58/100**
- Польза выделения единых сервисов (Nodes/Transitions/Tags/Relations): **92/100**

## Наблюдения

- Бизнес-логика нод частично находится в контроллерах (CRUD, теги, реакции, переходы, вычисление «следующих» нод), частично — во вспомогательных сервисах; админские операции дублируют поведение.
- В одном обработчике соседствуют валидация, авторизация, транзакции, побочные эффекты (эмбеддинги, уведомления/квесты, кеш‑инвалидация), что нарушает принцип единственной ответственности.
- Фильтры/параметры поиска для публичных и админских сценариев частично дублируются и расходятся.

## Цели

1. Свести бизнес‑правила в единые сервисы и политики (без копипаста).
2. Сделать контроллеры тонкими (вход/выход и делегирование).
3. Снизить количество побочных эффектов в контроллерах, перевести их на событийную/оркестрационную модель.
4. Единый способ фильтрации/пагинации и расширенные фильтры для админки.

## Предлагаемая структура

- `services/nodes/node_query_service.py` — чтение/поиск/листинги:
  - Унифицированные фильтры (теги, автор, статус, флаги), пагинация, сортировка.
  - Отдельные DTO/схемы ответов и ETag (где применимо).
- `services/nodes/node_service.py` — мутации:
  - `create/update/delete`, управление тегами, настройка реакций.
  - Явные транзакционные границы, валидация инвариантов.
- `services/transitions/transition_service.py` — связи/переходы:
  - Создание/обновление/удаление, получение «следующих» нод, режимы.
- `services/feedback.py` / `services/reactions.py` — опционально отделить пользовательскую активность.
- `policies/node_policy.py` — проверка прав для user/moderator/admin (владение, роли).
- `repositories/node_repository.py`, `repositories/transition_repository.py` — доступ к БД.
- События/оркестрация:
  - `domain_events` + `outbox` для: рекомпьют эмбеддингов, инвалидация кеша навигации, уведомления/квесты.

## План внедрения (поэтапно)

1. Read‑side first: вынести листинги/детальные чтения в `NodeQueryService`. 
   - Подключить публичные и админские эндпоинты к нему. 
   - Ввести единый объект фильтров (Spec/Query).
2. Вынести `create/update/delete` нод в `NodeService` с транзакциями и политиками.
3. Перенести операции с переходами в `TransitionService` (включая «следующие» ноды/режимы).
4. Отделить реакции/фидбек (при необходимости) в узкоспециализированные сервисы.
5. События/побочные эффекты: перевести прямые вызовы на доменные события (рекомпьют эмбеддингов, кеш‑инвалидацию, нотификации/квесты).
6. Упростить контроллеры: оставить только связывание HTTP ↔ DTO и вызов сервисов/политик.
7. Тесты: unit для сервисов/политик/репозиториев, интеграционные для контроллеров.
8. Документация: обновить схемы API, описать фильтры/ответы, политики.

## Риски и меры

- Риск регрессий при переносе логики — покрыть ключевые сценарии автотестами до миграции.
- Рост числа файлов/слоя — компенсируется снижением связности и упрощением поддержки.
- Производительность списков («следующие» ноды) — добавить индексы/кеширование в QueryService.

## Ожидаемый результат

- Сокращение дублирования, единый источник бизнес‑правил, проще расширять админку.
- Повышение читабельности (SRP), прозрачные транзакции и побочные эффекты.
- Лучшее тестирование (меньше моков на уровне контроллеров, больше изолированных unit‑тестов).
