# РЎС‚СЂР°С‚РµРіРёСЏ С‚РµСЃС‚РёСЂРѕРІР°РЅРёСЏ backend

## Р¦РµР»Рё
- РЈСЃС‚Р°РЅРѕРІРёС‚СЊ РµРґРёРЅС‹Рµ РїСЂР°РІРёР»Р° С…СЂР°РЅРµРЅРёСЏ Рё Р·Р°РїСѓСЃРєР° С‚РµСЃС‚РѕРІ, С‡С‚РѕР±С‹ РєРѕРґ РґРѕРјРµРЅРѕРІ СЃРѕРїСЂРѕРІРѕР¶РґР°Р»СЃСЏ РїСЂРѕРІРµСЂРєР°РјРё СЂСЏРґРѕРј СЃ Р±РёР·РЅРµСЃ-Р»РѕРіРёРєРѕР№.
- РћР±РµСЃРїРµС‡РёС‚СЊ РІРѕСЃРїСЂРѕРёР·РІРѕРґРёРјРѕСЃС‚СЊ Р»РѕРєР°Р»СЊРЅС‹С… Рё CI-РїСЂРѕРіРѕРЅРѕРІ Рё СЃРґРµР»Р°С‚СЊ СЏРІРЅС‹РјРё СЂР°Р·Р»РёС‡РёСЏ РјРµР¶РґСѓ Р±С‹СЃС‚СЂС‹РјРё Рё РґРѕР»РіРёРјРё РЅР°Р±РѕСЂР°РјРё.
- Р—Р°РґР°С‚СЊ РєСЂРёС‚РµСЂРёРё С‚РѕРіРѕ, С‡С‚Рѕ РёРјРµРЅРЅРѕ РјС‹ РїСЂРѕРІРµСЂСЏРµРј РЅР° РєР°Р¶РґРѕРј СѓСЂРѕРІРЅРµ (РґРѕРјРµРЅРЅС‹Рµ РїСЂР°РІРёР»Р°, РёРЅС‚РµРіСЂР°С†РёРё, РєРѕРЅС‚СЂР°РєС‚С‹, СЂРµРіСЂРµСЃСЃРёРё).

## РљР°СЂС‚Р° Р°СЂС‚РµС„Р°РєС‚РѕРІ
- `pytest` вЂ” РѕСЃРЅРѕРІРЅРѕР№ СЂР°РЅРЅРµСЂ; РєРѕРЅС„РёРіСѓСЂР°С†РёСЏ Р»РµР¶РёС‚ РІ `apps/backend/pytest.ini`.
- `tests/requirements-test.txt` СЃРѕРґРµСЂР¶РёС‚ РґРѕРїРѕР»РЅРёС‚РµР»СЊРЅС‹Рµ Р·Р°РІРёСЃРёРјРѕСЃС‚Рё, РєРѕС‚РѕСЂС‹Рµ СЃС‚Р°РІСЏС‚СЃСЏ РІ CI Рё РїСЂРё Р»РѕРєР°Р»СЊРЅРѕР№ РЅР°СЃС‚СЂРѕР№РєРµ РѕРєСЂСѓР¶РµРЅРёСЏ.
- `tests/conftest.py` вЂ” РіР»РѕР±Р°Р»СЊРЅС‹Рµ С„РёРєСЃС‚СѓСЂС‹ (РґРѕР±Р°РІР»РµРЅРёРµ backend РІ PYTHONPATH, FastAPI TestClient, РіРµРЅРµСЂР°С†РёСЏ JWT Рё С‚.Рґ.).
- Р”РѕРјРµРЅРЅС‹Рµ С„РёРєСЃС‚СѓСЂС‹ Рё С„Р°Р±СЂРёРєРё СЂР°Р·РјРµС‰Р°СЋС‚СЃСЏ РІ `apps/backend/domains/<domain>/tests/conftest.py`.

## РЎС‚СЂСѓРєС‚СѓСЂР° РєР°С‚Р°Р»РѕРіРѕРІ
```
apps/backend/
  domains/<domain>/
    tests/
      unit/           # С‡РёСЃС‚Р°СЏ РґРѕРјРµРЅРЅР°СЏ Р»РѕРіРёРєР°, СЃСѓС‰РЅРѕСЃС‚Рё, РІР°Р»РёРґР°С‚РѕСЂС‹
      application/    # СЃС†РµРЅР°СЂРёРё use-case, РєРѕРѕСЂРґРёРЅР°С†РёСЏ РїРѕСЂС‚РѕРІ, feature flags
      contract/       # РїСѓР±Р»РёС‡РЅС‹Рµ API Рё СЃРѕР±С‹С‚РёСЏ, РїСЂРѕРІРµСЂРєР° РїСЂРѕС‚РёРІ СЃС…РµРј
      integration/    # СЂР°Р±РѕС‚Р° С‡РµСЂРµР· СЂРµР°Р»СЊРЅС‹Рµ Р°РґР°РїС‚РµСЂС‹, Р‘Р”, Redis, РІРЅРµС€РЅРёРµ SDK
      load/           # РїСЂРѕС„РёР»РёСЂРѕРІР°РЅРёРµ, РґР»РёС‚РµР»СЊРЅС‹Рµ СЃС†РµРЅР°СЂРёРё, mark slow
      conftest.py     # РґРѕРјРµРЅРЅС‹Рµ С„РёРєСЃС‚СѓСЂС‹, builder'С‹, test data shortcuts
  packages/<pkg>/tests/   # РјРѕРґСѓР»СЊРЅС‹Рµ С‚РµСЃС‚С‹ РґР»СЏ РѕР±С‰РёС… Р±РёР±Р»РёРѕС‚РµРє

tests/
  unit/              # РєСЂРѕСЃСЃ-РґРѕРјРµРЅРЅС‹Рµ pure-python РїСЂРѕРІРµСЂРєРё СЏРґСЂР°
  platform/          # СЂРµРіСЂРµСЃСЃРёРё РїР»Р°С‚С„РѕСЂРјРµРЅРЅС‹С… РґРѕРјРµРЅРѕРІ РґРѕ РјРёРіСЂР°С†РёРё РІРЅСѓС‚СЂСЊ РґРѕРјРµРЅР°
  smoke/             # СЃРєРІРѕР·РЅС‹Рµ happy-path СЃС†РµРЅР°СЂРёРё API, РїСЂРёС‘РјРѕС‡РЅС‹Рµ РєРµР№СЃС‹
  conftest.py        # РіР»РѕР±Р°Р»СЊРЅС‹Рµ С„РёРєСЃС‚СѓСЂС‹, РґРѕСЃС‚СѓРїРЅС‹Рµ РІСЃРµРј С‚РµСЃС‚Р°Рј
```

> РџРѕ СѓРјРѕР»С‡Р°РЅРёСЋ РЅРѕРІС‹Рµ С‚РµСЃС‚С‹ РґРѕР±Р°РІР»СЏРµРј РІРЅСѓС‚СЂСЊ СЃРѕРѕС‚РІРµС‚СЃС‚РІСѓСЋС‰РµРіРѕ РґРѕРјРµРЅР°. РљР°С‚Р°Р»РѕРі `tests/` РѕСЃС‚Р°РІР»СЏРµРј РґР»СЏ СЃРєРІРѕР·РЅС‹С… СЃС†РµРЅР°СЂРёРµРІ, СЂРµРіСЂРµСЃСЃРёРѕРЅРЅС‹С… РЅР°Р±РѕСЂРѕРІ Рё РѕР±С‰РµРіРѕ РєРѕРґР°, РєРѕС‚РѕСЂС‹Р№ РЅРµ РїСЂРёРЅР°РґР»РµР¶РёС‚ РєРѕРЅРєСЂРµС‚РЅРѕРјСѓ РґРѕРјРµРЅСѓ.

## РўРёРїС‹ С‚РµСЃС‚РѕРІ Рё РѕР¶РёРґР°РµРјС‹Р№ РѕС…РІР°С‚
| РЎР»РѕР№ | РџР°РїРєР° | Р§С‚Рѕ РїСЂРѕРІРµСЂСЏРµРј | Р—Р°РјРµС‡Р°РЅРёСЏ |
| --- | --- | --- | --- |
| Р”РѕРјРµРЅРЅР°СЏ РјРѕРґРµР»СЊ (`domain/`) | `tests/unit` | РРЅРІР°СЂРёР°РЅС‚С‹ СЃСѓС‰РЅРѕСЃС‚РµР№, РїСЂР°РІРёР»Р° Р°РіСЂРµРіР°С†РёРё, СЂР°СЃС‡С‘С‚ СЃС‚Р°С‚СѓСЃРѕРІ, РѕРіСЂР°РЅРёС‡РµРЅРёСЏ РЅР° РґР°РЅРЅС‹Рµ | РўРѕР»СЊРєРѕ С‡РёСЃС‚С‹Р№ Python, Р±РµР· I/O. РСЃРїРѕР»СЊР·СѓРµРј `@pytest.mark.parametrize` РґР»СЏ РЅР°Р±РѕСЂР° edge-РєРµР№СЃРѕРІ. |
| Application/use-case | `tests/application` | РџРѕСЃР»РµРґРѕРІР°С‚РµР»СЊРЅРѕСЃС‚СЊ РІС‹Р·РѕРІРѕРІ РїРѕСЂС‚РѕРІ, РІР»РёСЏРЅРёРµ С„РёС‡-С„Р»Р°РіРѕРІ, С‚СЂР°РЅР·Р°РєС†РёРё, РѕР±СЂР°Р±РѕС‚РєР° РѕС€РёР±РѕРє | РРЅР¶РµРєС‚РёСЂСѓРµРј РїРѕСЂС‚С‹ С‡РµСЂРµР· Р·Р°РіР»СѓС€РєРё; РёСЃРїРѕР»СЊР·СѓРµРј `pytest-mock` РёР»Рё РїСЂРѕСЃС‚С‹Рµ С„РµР№РєРѕРІС‹Рµ Р°РґР°РїС‚РµСЂС‹. |
| API (`api/`) | `tests/contract` РёР»Рё РіР»РѕР±Р°Р»СЊРЅС‹Р№ `tests/smoke` | РЎС‚СЂСѓРєС‚СѓСЂР° РѕС‚РІРµС‚РѕРІ, РєРѕРґС‹ СЃС‚Р°С‚СѓСЃРѕРІ, Р°РІС‚РѕСЂРёР·Р°С†РёСЏ, РїР°РіРёРЅР°С†РёСЏ | РџСЂРѕРІРµСЂСЏРµРј РїСЂРѕС‚РёРІ СЃС…РµРј РёР· `packages/schemas`; РґР»СЏ РІС…РѕРґСЏС‰РёС… payloadРѕРІ вЂ” РІР°Р»РёРґР°С†РёСЏ Рё СЃРѕРѕР±С‰РµРЅРёСЏ РѕР± РѕС€РёР±РєР°С…. |
| РђРґР°РїС‚РµСЂС‹ Рё РёРЅС„СЂР°СЃС‚СЂСѓРєС‚СѓСЂР° | `tests/integration` | Р Р°Р±РѕС‚Р° С‡РµСЂРµР· СЂРµР°Р»СЊРЅС‹Рµ РєР»РёРµРЅС‚С‹ Р‘Р”/Redis/HTTP, РјРёРіСЂР°С†РёРё, СЃРѕРІРјРµСЃС‚РёРјРѕСЃС‚СЊ DTO в†” С…СЂР°РЅРёР»РёС‰Рµ | РњР°СЂРєРµСЂ `@pytest.mark.integration`. Р”Р»СЏ PostgreSQL РёСЃРїРѕР»СЊР·СѓРµРј РІСЂРµРјРµРЅРЅСѓСЋ Р‘Р”/С„РёРєСЃС‚СѓСЂС‹, РґР»СЏ Redis вЂ” `fakeredis`. |
| РЎРѕР±С‹С‚РёСЏ/РєРѕРЅС‚СЂР°РєС‚С‹ | `tests/contract` | РЎРѕРѕС‚РІРµС‚СЃС‚РІРёРµ JSON Schema (`packages/schemas`), РєРѕСЂСЂРµРєС‚РЅР°СЏ СЃРµСЂРёР°Р»РёР·Р°С†РёСЏ/РґРµСЃРµСЂРёР°Р»РёР·Р°С†РёСЏ СЃРѕР±С‹С‚РёР№ | РџРѕРґРЅРёРјР°РµРј С„РёРєСЃС‚СѓСЂСѓ СЃРѕ СЃС…РµРјР°РјРё; РЅРµСЃРѕРѕС‚РІРµС‚СЃС‚РІРёСЏ РїР°РґР°СЋС‚ РєР°Рє `ValidationError`. |
| РќР°РіСЂСѓР·РѕС‡РЅС‹Рµ СЃС†РµРЅР°СЂРёРё | `tests/load` | Time-to-service, РїСЂРѕС„РёР»РёСЂРѕРІР°РЅРёРµ РґРѕР»РіРёС… СЃРєСЂРёРїС‚РѕРІ, СѓСЃС‚РѕР№С‡РёРІРѕСЃС‚СЊ Рє СЂРѕСЃС‚Сѓ РґР°РЅРЅС‹С… | РћС‚РјРµС‡Р°РµРј `@pytest.mark.slow` Рё Р·Р°РїСѓСЃРєР°РµРј РїРѕ СЂР°СЃРїРёСЃР°РЅРёСЋ. |
| РЎРєРІРѕР·РЅС‹Рµ smoke/regression | `tests/smoke` | РћСЃРЅРѕРІРЅС‹Рµ РїРѕР»СЊР·РѕРІР°С‚РµР»СЊСЃРєРёРµ СЃС†РµРЅР°СЂРёРё (СЃРѕР·РґР°РЅРёРµ/С‡С‚РµРЅРёРµ РѕР±СЉРµРєС‚РѕРІ, happy-path API) | Р”РѕР»Р¶РЅС‹ Р±С‹СЃС‚СЂРѕ РІРѕСЃРїСЂРѕРёР·РІРѕРґРёС‚СЊ РєСЂРёС‚РёС‡РµСЃРєРёРµ СЂРµРіСЂРµСЃСЃРёРё; РґРѕСЃС‚СѓРї Рє TestClient Рё РІСЃРїРѕРјРѕРіР°С‚РµР»СЊРЅС‹Рј С…РµР»РїРµСЂР°Рј РёР· `tests/conftest.py`. |

## РЎРѕРіР»Р°С€РµРЅРёСЏ РїРѕ С‚РµСЃС‚Р°Рј
- **РРјРµРЅРѕРІР°РЅРёРµ:** С„Р°Р№Р»С‹ `test_*.py`, С„СѓРЅРєС†РёРё `test_*`. Р¤Р°Р±СЂРёРєРё/Р±РёР»РґРµСЂС‹ вЂ” `*_factory.py` РёР»Рё С„РёРєСЃС‚СѓСЂС‹.
- **Р¤РёРєСЃС‚СѓСЂС‹:** РІС‹РЅРѕСЃРёРј РІ `conftest.py` РЅР° СѓСЂРѕРІРЅРµ РєР°С‚Р°Р»РѕРіР°, РіРґРµ РёСЃРїРѕР»СЊР·СѓРµС‚СЃСЏ. РР·Р±РµРіР°РµРј РіР»РѕР±Р°Р»СЊРЅС‹С… side-effects; РµСЃР»Рё С„РёРєСЃС‚СѓСЂР° РјРѕРґРёС„РёС†РёСЂСѓРµС‚ РѕРєСЂСѓР¶РµРЅРёРµ, РѕС‡РёС‰Р°РµРј РїРѕСЃР»Рµ `yield`.
- **Async:** РёСЃРїРѕР»СЊР·СѓРµРј `pytest-asyncio`; С‚РµСЃС‚ РїРѕРјРµС‡Р°РµРј `async def test_...` Р±РµР· РґРѕРїРѕР»РЅРёС‚РµР»СЊРЅС‹С… РґРµРєРѕСЂР°С‚РѕСЂРѕРІ (РїР»Р°РіРёРЅ СѓР¶Рµ СѓСЃС‚Р°РЅРѕРІР»РµРЅ).
- **РњР°СЂРєРµСЂС‹:**
  - `@pytest.mark.integration` вЂ” С‚РµСЃС‚ С‚СЂРµР±СѓРµС‚ СЂРµР°Р»СЊРЅРѕРіРѕ СЂРµСЃСѓСЂСЃР°, РёСЃРєР»СЋС‡Р°РµРј РёР· РґРµС„РѕР»С‚РЅРѕРіРѕ РЅР°Р±РѕСЂР°.
  - `@pytest.mark.contract` вЂ” СѓС‡Р°СЃС‚РёРµ РІ РїСЂРѕРІРµСЂРєРµ API/СЃРѕР±С‹С‚РёР№, РїСѓР±Р»РёРєСѓРµРј Р°СЂС‚РµС„Р°РєС‚С‹ (JSON payload) СЂСЏРґРѕРј СЃ С‚РµСЃС‚РѕРј.
  - `@pytest.mark.slow` вЂ” РґРѕР»РіРёРµ СЃС†РµРЅР°СЂРёРё (РЅР°РіСЂСѓР·РєР°, РјРёРіСЂР°С†РёРё, end-to-end). Р Р°Р±РѕС‚Р°СЋС‚ РІ nightly pipeline.
  - `@pytest.mark.load` вЂ” РЅР°РіСЂСѓР·РѕС‡РЅС‹Рµ/РїСЂРѕС„РёР»РёСЂРѕРІРѕС‡РЅС‹Рµ С‚РµСЃС‚С‹; Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРё СЃС‡РёС‚Р°СЋС‚СЃСЏ `slow`.
- **РўРµСЃС‚РѕРІС‹Рµ РґР°РЅРЅС‹Рµ:** РїСЂРµРґРїРѕС‡С‚РёС‚РµР»СЊРЅРѕ СЃРѕР·РґР°РІР°С‚СЊ builder-С„СѓРЅРєС†РёРё РёР»Рё РЅРµР±РѕР»СЊС€РёРµ РѕР±СЉРµРєС‚С‹ РІРЅСѓС‚СЂРё С„РёРєСЃС‚СѓСЂ. Р–С‘СЃС‚РєРѕ РїСЂРѕС€РёС‚С‹Рµ JSON С…СЂР°РЅРёРј РІ `tests/<...>/fixtures/*.json`.
- **РњРѕРєРё Рё Р·Р°РіР»СѓС€РєРё:** РѕС‚РґР°С‘Рј РїСЂРµРґРїРѕС‡С‚РµРЅРёРµ in-memory СЂРµР°Р»РёР·Р°С†РёСЏРј РїРѕСЂС‚РѕРІ Рё `fakeredis`. РџСЂСЏРјС‹Рµ monkeypatch'Рё С‚РѕР»СЊРєРѕ РІ РёСЃРєР»СЋС‡РёС‚РµР»СЊРЅС‹С… СЃР»СѓС‡Р°СЏС….

## Р—Р°РїСѓСЃРє Р»РѕРєР°Р»СЊРЅРѕ
```bash
# Р’СЃРµ Р±С‹СЃС‚СЂС‹Рµ С‚РµСЃС‚С‹ РёР· РєРѕСЂРЅСЏ СЂРµРїРѕР·РёС‚РѕСЂРёСЏ
cd apps/backend
python -m pytest -m "not slow" -c pytest.ini

# РўРµСЃС‚С‹ РєРѕРЅРєСЂРµС‚РЅРѕРіРѕ РґРѕРјРµРЅР°
python -m pytest domains/platform/moderation/tests -m "not integration" -c pytest.ini

# Р—Р°РїСѓСЃС‚РёС‚СЊ С‚РѕР»СЊРєРѕ smoke-СЃС†РµРЅР°СЂРёРё
python -m pytest ../../tests/smoke -c pytest.ini

# РџСЂРѕРіРѕРЅ СЃ РёР·РјРµСЂРµРЅРёРµРј РїРѕРєСЂС‹С‚РёСЏ (РїРѕ Р¶РµР»Р°РЅРёСЋ)
coverage run -m pytest -c pytest.ini && coverage html
```
- Р”Р»СЏ СѓСЃРєРѕСЂРµРЅРёСЏ Р»РѕРєР°Р»СЊРЅРѕРіРѕ Р·Р°РїСѓСЃРєР° РјРѕР¶РЅРѕ СѓСЃС‚Р°РЅРѕРІРёС‚СЊ Р·Р°РІРёСЃРёРјРѕСЃС‚Рё `pip install -r tests/requirements-test.txt` (РѕРЅРё СѓР¶Рµ СЃС‚Р°РІСЏС‚СЃСЏ РІ CI).
- РџРµСЂРµРґ РїСѓС€РµРј СЂРµРєРѕРјРµРЅРґСѓРµС‚СЃСЏ РІС‹РїРѕР»РЅРёС‚СЊ `make test` (Р·Р°РїСѓСЃРєР°РµС‚ `pytest -q`) Рё, РїСЂРё РёР·РјРµРЅРµРЅРёСЏС… РІ С‚РёРїР°С…, `make typecheck`.



## РўРµР»РµРјРµС‚СЂРёСЏ RUM
- `tests/unit/telemetry/test_rum_repository.py` РїСЂРѕРІРµСЂСЏРµС‚ СЂР°Р·РґРµР»СЊРЅРѕРµ С…СЂР°РЅРµРЅРёРµ РѕС€РёР±РѕРє (30 РґРЅРµР№) Рё РєРѕСЂРѕС‚РєРѕР¶РёРІСѓС‰РёС… СЃРѕСЃС‚РѕСЏРЅРёР№ (72 С‡Р°СЃР°) РІ Redis Рё Р°РіСЂРµРіР°С†РёСЋ РїРѕ РјРёРЅСѓС‚РЅС‹Рј Р±Р°РєРµС‚Р°Рј.
- `tests/unit/telemetry/test_rum_rollup_worker.py` РїРѕРєСЂС‹РІР°РµС‚ С„РѕРЅРѕРІРѕРіРѕ РІРѕСЂРєРµСЂР° `telemetry.rum_rollup`, РєРѕС‚РѕСЂС‹Р№ РІС‹РіСЂСѓР¶Р°РµС‚ РіРѕС‚РѕРІС‹Рµ Р°РіСЂРµРіР°С‚С‹ Рё РѕС‡РёС‰Р°РµС‚ РѕС‡РµСЂРµРґСЊ РѕС‚ РѕР±СЂР°Р±РѕС‚Р°РЅРЅС‹С… РєР»СЋС‡РµР№.
- РљРѕРЅС„РёРіСѓСЂР°С†РёСЏ РІРѕСЂРєРµСЂР° Р·Р°РґР°РµС‚СЃСЏ С‡РµСЂРµР· РїРѕР»СЏ `Settings`: `rum_rollup_interval_sec`, `rum_rollup_min_age_sec`, `rum_rollup_batch_size`, Р° Р±СѓРґСѓС‰РёР№ СЌРєСЃРїРѕСЂС‚ РІ S3 вЂ” РїРµСЂРµРјРµРЅРЅС‹РјРё `rum_export_s3_bucket`, `rum_export_s3_prefix`, `rum_export_s3_region`, `rum_export_compress`. РџРѕ СѓРјРѕР»С‡Р°РЅРёСЋ bucket РїСѓСЃС‚РѕР№, РїРѕСЌС‚РѕРјСѓ РІС‹РіСЂСѓР·РєР° РІС‹РєР»СЋС‡РµРЅР°.
- Р”Р»СЏ СЂСѓС‡РЅРѕРіРѕ Р·Р°РїСѓСЃРєР° РёСЃРїРѕР»СЊР·СѓРµРј `python -m apps.backend.workers telemetry -- --log-level INFO`; РґРѕРїРѕР»РЅРёС‚РµР»СЊРЅС‹Рµ Р°СЂРіСѓРјРµРЅС‚С‹ РїРѕСЃР»Рµ `--` РїСЂРѕРєСЃРёСЂСѓСЋС‚СЃСЏ РІ `packages.worker.runner`.


## CI Рё СЂР°СЃРїРёСЃР°РЅРёСЏ
- GitHub Actions (`.github/workflows/ci.yml`) Р·Р°РїСѓСЃРєР°РµС‚ Р»РёРЅС‚РµСЂС‹ (`ruff`, `mypy`) Рё `python -m pytest -c pytest.ini` РЅР° РєР°Р¶РґС‹Р№ push/PR. Р’ РґРµС„РѕР»С‚РЅС‹Р№ РїСЂРѕРіРѕРЅ РїРѕРїР°РґР°СЋС‚ РІСЃРµ С‚РµСЃС‚С‹ Р±РµР· РјР°СЂРєРµСЂР° `slow`.
- РќРѕС‡РЅРѕР№ РїР°Р№РїР»Р°Р№РЅ (`ci-nightly.yml`) РґРѕРїРѕР»РЅРёС‚РµР»СЊРЅРѕ РІС‹РїРѕР»РЅСЏРµС‚ `python -m pytest -c pytest.ini -m slow --durations=20`. Р”РѕР±Р°РІР»СЏР№С‚Рµ `@pytest.mark.slow` РєРѕ РІСЃРµРј РЅР°РіСЂСѓР·РѕС‡РЅС‹Рј/РґРѕР»РіРёРј СЃС†РµРЅР°СЂРёСЏРј, С‡С‚РѕР±С‹ РѕРЅРё РѕРєР°Р·С‹РІР°Р»РёСЃСЊ РёРјРµРЅРЅРѕ С‚Р°Рј.
- Р•СЃР»Рё РґРѕРјРµРЅРЅС‹Р№ С‚РµСЃС‚ С‚СЂРµР±СѓРµС‚ РёРЅС„СЂР°СЃС‚СЂСѓРєС‚СѓСЂСѓ (PostgreSQL, Redis), РёСЃРїРѕР»СЊР·СѓРµРј Docker-compose РїСЂРѕС„РёР»СЊ `infra/docker-compose.yml` Р»РѕРєР°Р»СЊРЅРѕ Рё РґРѕР±Р°РІР»СЏРµРј С€Р°Рі Р·Р°РїСѓСЃРєР° СЃРµСЂРІРёСЃРѕРІ РІ РѕС‚РґРµР»СЊРЅС‹Рµ job-С‹, РїСЂРµР¶РґРµ С‡РµРј РІРєР»СЋС‡Р°С‚СЊ С‚РµСЃС‚ РІ РѕСЃРЅРѕРІРЅРѕР№ pipeline.
- РџСЂРё РґРѕР±Р°РІР»РµРЅРёРё РЅРѕРІРѕРіРѕ РїР°РєРµС‚Р° РёР»Рё РґРѕРјРµРЅР° РЅРµ Р·Р°Р±С‹РІР°РµРј РїСЂРѕРІРµСЂРёС‚СЊ, С‡С‚Рѕ РїСѓС‚СЊ СЃ С‚РµСЃС‚Р°РјРё РїРѕРїР°РґР°РµС‚ РІ `pytest.ini::testpaths`.

## Definition of Done РґР»СЏ Р·Р°РґР°С‡ backend
- РќРѕРІР°СЏ Р±РёР·РЅРµСЃ-С„СѓРЅРєС†РёСЏ СЃРѕРїСЂРѕРІРѕР¶РґР°РµС‚СЃСЏ РєР°Рє РјРёРЅРёРјСѓРј РѕРґРЅРёРј С‚РµСЃС‚РѕРј РЅР° РґРѕРјРµРЅРЅСѓСЋ Р»РѕРіРёРєСѓ Рё РѕРґРЅРёРј С‚РµСЃС‚РѕРј РЅР° РїСѓР±Р»РёС‡РЅС‹Р№ РєРѕРЅС‚СЂР°РєС‚ (API/СЃРѕР±С‹С‚РёРµ).
- РСЃРїСЂР°РІР»РµРЅРёРµ Р±Р°РіР° СЃРѕРїСЂРѕРІРѕР¶РґР°РµС‚СЃСЏ СЂРµРіСЂРµСЃСЃРёРѕРЅРЅС‹Рј С‚РµСЃС‚РѕРј, РІРѕСЃРїСЂРѕРёР·РІРѕРґСЏС‰РёРј РёСЃС…РѕРґРЅСѓСЋ РїСЂРѕР±Р»РµРјСѓ.
- Р’СЃРµ РЅРѕРІС‹Рµ РёРЅС‚РµРіСЂР°С†РёРё РёРјРµСЋС‚ `integration`-С‚РµСЃС‚ СЃ РїСЂРѕРІРµСЂРєРѕР№ happy-path Рё РѕС€РёР±РѕРє (СЃ РёСЃРїРѕР»СЊР·РѕРІР°РЅРёРµРј in-memory/fake СѓСЃР»СѓРі, РµСЃР»Рё РЅРµС‚ Р±РѕРµРІРѕРіРѕ РґРѕСЃС‚СѓРїР°).
- РџСЂРё РґРѕР±Р°РІР»РµРЅРёРё РґР»РёС‚РµР»СЊРЅРѕРіРѕ СЃС†РµРЅР°СЂРёСЏ РѕР±СЏР·Р°С‚РµР»СЊРЅРѕ РїРѕРјРµС‡Р°РµРј РµРіРѕ `slow` Рё РѕРїРёСЃС‹РІР°РµРј, РєР°Рє РїРѕРґРіРѕС‚РѕРІРёС‚СЊ РґР°РЅРЅС‹Рµ/РѕРєСЂСѓР¶РµРЅРёРµ РІ readme РґРѕРјРµРЅР°.
- Р”РѕРєСѓРјРµРЅС‚Р°С†РёСЏ РґРѕРјРµРЅР° (`apps/backend/domains/<domain>/docs/TESTPLAN.md`) РґРѕР»Р¶РЅР° СЃСЃС‹Р»Р°С‚СЊСЃСЏ РЅР° Р°РєС‚СѓР°Р»СЊРЅС‹Рµ С‚РµСЃС‚РѕРІС‹Рµ СЃС†РµРЅР°СЂРёРё Рё fixtures.

## РњРёРіСЂР°С†РёСЏ СЃСѓС‰РµСЃС‚РІСѓСЋС‰РёС… С‚РµСЃС‚РѕРІ
- РџСЂРё РёР·РјРµРЅРµРЅРёРё РґРѕРјРµРЅР° РїРµСЂРµРЅРѕСЃРёРј СЃРѕРѕС‚РІРµС‚СЃС‚РІСѓСЋС‰РёРµ С‚РµСЃС‚С‹ РёР· `tests/platform/...` РІРЅСѓС‚СЂСЊ `apps/backend/domains/<domain>/tests` СЃ СЃРѕС…СЂР°РЅРµРЅРёРµРј СЃС‚СЂСѓРєС‚СѓСЂС‹.
- РџРѕСЃР»Рµ РїРµСЂРµРЅРѕСЃР° СѓР±РµР¶РґР°РµРјСЃСЏ, С‡С‚Рѕ РіР»РѕР±Р°Р»СЊРЅС‹Рµ С„РёРєСЃС‚СѓСЂС‹ РѕСЃС‚Р°СЋС‚СЃСЏ РґРѕСЃС‚СѓРїРЅС‹РјРё (РїСЂРё РЅРµРѕР±С…РѕРґРёРјРѕСЃС‚Рё РёРјРїРѕСЂС‚РёСЂСѓРµРј РёС… РёР· `tests.conftest`).
- Р—Р°РІРёСЃРёРјРѕСЃС‚Рё, РЅСѓР¶РЅС‹Рµ С‚РѕР»СЊРєРѕ РґРѕРјРµРЅРЅС‹Рј С‚РµСЃС‚Р°Рј, РґРѕР±Р°РІР»СЏРµРј РІ `apps/backend/pyproject.toml` РёР»Рё Р»РѕРєР°Р»СЊРЅС‹Р№ `requirements-test.txt` РІ РєР°С‚Р°Р»РѕРіРµ РґРѕРјРµРЅР°.

Р”РѕРєСѓРјРµРЅС‚ РѕР±РЅРѕРІР»СЏРµС‚СЃСЏ РїРѕ РјРµСЂРµ РїРѕСЏРІР»РµРЅРёСЏ РЅРѕРІС‹С… РґРѕРјРµРЅРѕРІ, С‚РёРїРѕРІ С‚РµСЃС‚РѕРІ Рё РїР°Р№РїР»Р°Р№РЅРѕРІ. РџСЂРµРґР»РѕР¶РµРЅРёСЏ РїРѕ СѓР»СѓС‡С€РµРЅРёСЋ вЂ” С‡РµСЂРµР· PR СЃ РёР·РјРµРЅРµРЅРёРµРј СЌС‚РѕРіРѕ С„Р°Р№Р»Р°.

## Wave 0 — baseline и задачи
- Покрытие pytest: 88.92% (цель 85%) — обновлено 2025-10-11. Источники: coverage.xml, var/coverage-summary.json. Ответственная @svetlana.t.
- Import Linter: нарушений нет (см. `var/backend-import-lint.txt`). Контроль @a.egorov.
- Validate repo: Bandit падает на B110/B105/B311 (подробности в `reports/validate_repo.md`). Нужен фикс в пакете `core` и worker retry.
- API бенчмарки: AttributeError по `NavigationService` ломает `nodes:list`, `moderation:cases` (`var/api-benchmarks.json`).

### Wave-1 чек-лист
- [ ] Закрыть Bandit-алерты (`core.config`, `core.db`, `core.telemetry`, `core.settings_contract`, `worker.base`).
- [ ] Добавить unit/contract-тесты для `api_gateway.debug` и navigation-services, поднять покрытие ≥85%.
- [ ] Прогнать smoke API после фикса и обновить `api-benchmarks.json`.
- [ ] Автоматизировать публикацию coverage/linters в CI summary.


## Типизация
- 2025-10-11 — включён строгий mypy (flags: warn_unused_ignores, disallow_any_generics) для модулей domains.platform.moderation.*, domains.product.nodes.application.service, domains.product.nodes.adapters.memory.utils, pps.backend.migrations.versions.0100_squashed_base. Ответственные: команда Wave 2 Backend (W2-2).
