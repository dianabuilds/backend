# Стратегия тестирования backend

## Цели
- Установить единые правила хранения и запуска тестов, чтобы код доменов сопровождался проверками рядом с бизнес-логикой.
- Обеспечить воспроизводимость локальных и CI-прогонов и сделать явными различия между быстрыми и долгими наборами.
- Задать критерии того, что именно мы проверяем на каждом уровне (доменные правила, интеграции, контракты, регрессии).

## Карта артефактов
- `pytest` — основной раннер; конфигурация лежит в `apps/backend/pytest.ini`.
- `tests/requirements-test.txt` содержит дополнительные зависимости, которые ставятся в CI и при локальной настройке окружения.
- `tests/conftest.py` — глобальные фикстуры (добавление backend в PYTHONPATH, FastAPI TestClient, генерация JWT и т.д.).
- Доменные фикстуры и фабрики размещаются в `apps/backend/domains/<domain>/tests/conftest.py`.

## Структура каталогов
```
apps/backend/
  domains/<domain>/
    tests/
      unit/           # чистая доменная логика, сущности, валидаторы
      application/    # сценарии use-case, координация портов, feature flags
      contract/       # публичные API и события, проверка против схем
      integration/    # работа через реальные адаптеры, БД, Redis, внешние SDK
      load/           # профилирование, длительные сценарии, mark slow
      conftest.py     # доменные фикстуры, builder'ы, test data shortcuts
  packages/<pkg>/tests/   # модульные тесты для общих библиотек

tests/
  unit/              # кросс-доменные pure-python проверки ядра
  platform/          # регрессии платформенных доменов до миграции внутрь домена
  smoke/             # сквозные happy-path сценарии API, приёмочные кейсы
  conftest.py        # глобальные фикстуры, доступные всем тестам
```

> По умолчанию новые тесты добавляем внутрь соответствующего домена. Каталог `tests/` оставляем для сквозных сценариев, регрессионных наборов и общего кода, который не принадлежит конкретному домену.

## Типы тестов и ожидаемый охват
| Слой | Папка | Что проверяем | Замечания |
| --- | --- | --- | --- |
| Доменная модель (`domain/`) | `tests/unit` | Инварианты сущностей, правила агрегации, расчёт статусов, ограничения на данные | Только чистый Python, без I/O. Используем `@pytest.mark.parametrize` для набора edge-кейсов. |
| Application/use-case | `tests/application` | Последовательность вызовов портов, влияние фич-флагов, транзакции, обработка ошибок | Инжектируем порты через заглушки; используем `pytest-mock` или простые фейковые адаптеры. |
| API (`api/`) | `tests/contract` или глобальный `tests/smoke` | Структура ответов, коды статусов, авторизация, пагинация | Проверяем против схем из `packages/schemas`; для входящих payloadов — валидация и сообщения об ошибках. |
| Адаптеры и инфраструктура | `tests/integration` | Работа через реальные клиенты БД/Redis/HTTP, миграции, совместимость DTO ↔ хранилище | Маркер `@pytest.mark.integration`. Для PostgreSQL используем временную БД/фикстуры, для Redis — `fakeredis`. |
| События/контракты | `tests/contract` | Соответствие JSON Schema (`packages/schemas`), корректная сериализация/десериализация событий | Поднимаем фикстуру со схемами; несоответствия падают как `ValidationError`. |
| Нагрузочные сценарии | `tests/load` | Time-to-service, профилирование долгих скриптов, устойчивость к росту данных | Отмечаем `@pytest.mark.slow` и запускаем по расписанию. |
| Сквозные smoke/regression | `tests/smoke` | Основные пользовательские сценарии (создание/чтение объектов, happy-path API) | Должны быстро воспроизводить критические регрессии; доступ к TestClient и вспомогательным хелперам из `tests/conftest.py`. |

## Соглашения по тестам
- **Именование:** файлы `test_*.py`, функции `test_*`. Фабрики/билдеры — `*_factory.py` или фикстуры.
- **Фикстуры:** выносим в `conftest.py` на уровне каталога, где используется. Избегаем глобальных side-effects; если фикстура модифицирует окружение, очищаем после `yield`.
- **Async:** используем `pytest-asyncio`; тест помечаем `async def test_...` без дополнительных декораторов (плагин уже установлен).
- **Маркеры:**
  - `@pytest.mark.integration` — тест требует реального ресурса, исключаем из дефолтного набора.
  - `@pytest.mark.contract` — участие в проверке API/событий, публикуем артефакты (JSON payload) рядом с тестом.
  - `@pytest.mark.slow` — долгие сценарии (нагрузка, миграции, end-to-end). Работают в nightly pipeline.
  - `@pytest.mark.load` — нагрузочные/профилировочные тесты; автоматически считаются `slow`.
- **Тестовые данные:** предпочтительно создавать builder-функции или небольшие объекты внутри фикстур. Жёстко прошитые JSON храним в `tests/<...>/fixtures/*.json`.
- **Моки и заглушки:** отдаём предпочтение in-memory реализациям портов и `fakeredis`. Прямые monkeypatch'и только в исключительных случаях.

## Запуск локально
```bash
# Все быстрые тесты из корня репозитория
cd apps/backend
python -m pytest -m "not slow" -c pytest.ini

# Тесты конкретного домена
python -m pytest domains/platform/moderation/tests -m "not integration" -c pytest.ini

# Запустить только smoke-сценарии
python -m pytest ../../tests/smoke -c pytest.ini

# Прогон с измерением покрытия (по желанию)
coverage run -m pytest -c pytest.ini && coverage html
```
- Для ускорения локального запуска можно установить зависимости `pip install -r tests/requirements-test.txt` (они уже ставятся в CI).
- Перед пушем рекомендуется выполнить `make test` (запускает `pytest -q`) и, при изменениях в типах, `make typecheck`.



## Телеметрия RUM
- `tests/unit/telemetry/test_rum_repository.py` проверяет раздельное хранение ошибок (30 дней) и короткоживущих состояний (72 часа) в Redis и агрегацию по минутным бакетам.
- `tests/unit/telemetry/test_rum_rollup_worker.py` покрывает фонового воркера `telemetry.rum_rollup`, который выгружает готовые агрегаты и очищает очередь от обработанных ключей.
- Конфигурация воркера задается через поля `Settings`: `rum_rollup_interval_sec`, `rum_rollup_min_age_sec`, `rum_rollup_batch_size`, а будущий экспорт в S3 — переменными `rum_export_s3_bucket`, `rum_export_s3_prefix`, `rum_export_s3_region`, `rum_export_compress`. По умолчанию bucket пустой, поэтому выгрузка выключена.
- Для ручного запуска используем `python -m apps.backend.workers telemetry -- --log-level INFO`; дополнительные аргументы после `--` проксируются в `packages.worker.runner`.


## CI и расписания
- GitHub Actions (`.github/workflows/ci.yml`) запускает линтеры (`ruff`, `mypy`) и `python -m pytest -c pytest.ini` на каждый push/PR. В дефолтный прогон попадают все тесты без маркера `slow`.
- Ночной пайплайн (`ci-nightly.yml`) дополнительно выполняет `python -m pytest -c pytest.ini -m slow --durations=20`. Добавляйте `@pytest.mark.slow` ко всем нагрузочным/долгим сценариям, чтобы они оказывались именно там.
- Если доменный тест требует инфраструктуру (PostgreSQL, Redis), используем Docker-compose профиль `infra/docker-compose.yml` локально и добавляем шаг запуска сервисов в отдельные job-ы, прежде чем включать тест в основной pipeline.
- При добавлении нового пакета или домена не забываем проверить, что путь с тестами попадает в `pytest.ini::testpaths`.

## Definition of Done для задач backend
- Новая бизнес-функция сопровождается как минимум одним тестом на доменную логику и одним тестом на публичный контракт (API/событие).
- Исправление бага сопровождается регрессионным тестом, воспроизводящим исходную проблему.
- Все новые интеграции имеют `integration`-тест с проверкой happy-path и ошибок (с использованием in-memory/fake услуг, если нет боевого доступа).
- При добавлении длительного сценария обязательно помечаем его `slow` и описываем, как подготовить данные/окружение в readme домена.
- Документация домена (`apps/backend/domains/<domain>/docs/TESTPLAN.md`) должна ссылаться на актуальные тестовые сценарии и fixtures.

## Миграция существующих тестов
- При изменении домена переносим соответствующие тесты из `tests/platform/...` внутрь `apps/backend/domains/<domain>/tests` с сохранением структуры.
- После переноса убеждаемся, что глобальные фикстуры остаются доступными (при необходимости импортируем их из `tests.conftest`).
- Зависимости, нужные только доменным тестам, добавляем в `apps/backend/pyproject.toml` или локальный `requirements-test.txt` в каталоге домена.

Документ обновляется по мере появления новых доменов, типов тестов и пайплайнов. Предложения по улучшению — через PR с изменением этого файла.
