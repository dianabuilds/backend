# Стратегия тестирования backend

Документ описывает, как организованы тесты в монорепозитории и какие правила нужно соблюдать при добавлении новых сценариев. Он заменяет устаревшие заметки с журналами «волн» и фиксирует только актуальные инструкции.

## Цели
- поддерживать единый порядок хранения тестов в доменах и пакетах;
- обеспечивать воспроизводимость локальных и CI-прогонов;
- явно разделять быстрые и долгие наборы, чтобы не тормозить разработку.

## Основные артефакты
- `pytest` — основной раннер; конфигурация лежит в `apps/backend/pytest.ini`.
- `tests/requirements-test.txt` — дополнительный набор зависимостей для CI и локальной настройки.
- `tests/conftest.py` — глобальные фикстуры (PYTHONPATH, FastAPI `TestClient`, генерация JWT и т.п.).
- Отчёты покрытия сохраняем в `reports/pytest/` (XML/HTML), логи падений — в `reports/pytest/logs/`.

## Структура каталогов
```
apps/backend/
  domains/<domain>/
    tests/
      unit/           # чистая доменная логика, сущности, валидаторы
      application/    # use-case сценарии, координация портов, feature flags
      contract/       # публичные API и события, проверка против схем
      integration/    # работа через реальные адаптеры (БД, Redis, внешние SDK)
      slow/           # длительные сценарии, помечаем mark.slow
      conftest.py     # доменные фикстуры, builder'ы, shortcuts для данных
  packages/<pkg>/tests/   # тесты для общих библиотек и утилит

tests/
  unit/              # кросс-доменные проверки ядра
  platform/          # регрессии платформенных доменов до миграции внутрь домена
  smoke/             # сквозные happy-path сценарии API
  conftest.py        # глобальные фикстуры, доступные всем наборам
```

## Фикстуры и тестовые данные
- Доменные фикстуры живут в `apps/backend/domains/<domain>/tests/conftest.py` и используют builder-паттерны для сущностей.
- Общие фикстуры (JWT, временные каталоги, mock Redis) располагаются в корневом `tests/conftest.py`.
- Для интеграционных тестов допускается использование временной БД/Redis. Такой сценарий помечаем `@pytest.mark.integration`.
- Сидированные датасеты храним в `tests/fixtures/<name>.json` и загружаем через фикстуры.

## Контуры проверок
- **Unit** — изолированные тесты на доменную логику, стартуют по умолчанию при `pytest -q`.
- **Application** — проверяют сценарии использования, взаимодействие с портами, feature flags.
- **Contract** — сверяют ответы API и события с контрактами/схемами (OpenAPI, Pydantic).
- **Integration** — запускают реальный транспорт и адаптеры; помечаются `@pytest.mark.integration`.
- **Smoke** — минимальные happy-path сценарии API, запускаются в CI на каждом PR.
- **Slow/Perf** — профилирование и длительные кейсы, группируются маркировкой `slow` и `perf`. По умолчанию пропускаются (`-m "not slow"`).

## Запуск
- Все тесты:  
  ```bash
  pytest -c apps/backend/pytest.ini
  ```
- Быстрые проверки (без integration/slow):  
  ```bash
  pytest -c apps/backend/pytest.ini -m "not integration and not slow"
  ```
- Тесты конкретного домена:  
  ```bash
  pytest apps/backend/domains/<domain>/tests -c apps/backend/pytest.ini
  ```
- Покрытие:  
  ```bash
  pytest -c apps/backend/pytest.ini --cov=apps/backend --cov-report=xml:reports/pytest/coverage.xml
  ```

## Маркировки
- `@pytest.mark.integration` — обращение к реальным адаптерам или внешним сервисам.
- `@pytest.mark.slow` — сценарии дольше ~2 минут или требующие больших ресурсов.
- `@pytest.mark.asyncio` — асинхронные тесты.
- `@pytest.mark.parametrize` — используем для матриц входных данных, избегаем дублирования.

## Контроль качества
- Покрытие по ключевым доменам должно оставаться >= 85% (см. `docs/code-audit-playbook.md`).
- При добавлении новых тестов обновляем чек-листы и фикстуры, описываем особенности в README соответствующего домена.
- Падения smoke-тестов анализируем сразу; логи CI сохраняются как артефакты GitHub Actions.

## Интеграция с CI
- Workflow `.github/workflows/ci.yml` запускает джобы `backend-quality` (линеры, mypy, unit) и `backend-contour-smoke` (smoke-сценарии по контурам).
- Для долговременных наборов используется `ci-nightly.yml` — прогоняет slow/perf, обновляет отчёты и публикует артефакты.
- Все зависимости для CI устанавливаются из `tests/requirements-test.txt`; не добавляйте туда опциональные пакеты без обсуждения.

## Связанные документы
- `docs/code-audit-playbook.md` — общие правила аудита и метрик.
- `docs/performance-playbook.md` — профилирование и контроль производительности.
- `docs/admin-node-engagement-task-breakdown.md` и другие runbook'и — описание предметных сценариев, требующих тестового покрытия.
