# Требования к безопасной разработке и проверке кода

## Назначение
Документ устанавливает единый набор требований безопасности, которым должны соответствовать все изменения в репозитории. Цель — выявлять и устранять уязвимости на этапе ревью кода, снижать операционные риски и обеспечивать соблюдение регуляторных и корпоративных норм.

## Область применения
Требования распространяются на backend, frontend, инфраструктурные скрипты, миграции, тесты и вспомогательные утилиты. Любой код, который может повлиять на безопасность данных, пользователей или инфраструктуры, должен проверяться по этому документу.

## Роли и ответственность
- **Автор изменений** — подтверждает соответствие требованиям, добавляет тесты и документацию по безопасности.
- **Ревьюер** — проверяет изменения по чек-листу, классифицирует нарушения, запрашивает исправления.
- **Security Champion/ответственный за безопасность** — помогает интерпретировать требования, согласовывает отступления и инцидентные сценарии.

## Шкала серьёзности замечаний
- **Blocker** — критическая уязвимость, даёт прямой вектор атаки или нарушает обязательства по защите данных. Мерж запрещён до исправления.
- **Major** — значимый риск, который может привести к компрометации, но требует стечения обстоятельств. Требуется исправление до релиза.
- **Minor** — низкий риск или потенциальное ухудшение защиты. Можно принять с задачей в бэклог.
- **Note** — рекомендация, не влияющая напрямую на безопасность, но повышающая прозрачность или устойчивость.

## Процесс использования документа
1. Автор при подготовке MR/PR отмечает потенциальные изменения из чек-листа и добавляет контекст (архитектура, угрозы, миграции).
2. Ревьюер проходит разделы, релевантные изменению. Если раздел не применим, это фиксируется в комментарии.
3. Для каждого выявленного нарушения фиксируется серьёзность, описание и рекомендуемое исправление.
4. После исправлений ревьюер повторно проверяет критичные пункты, сверяет автоматические проверки (linters, SAST, dependency audit).
5. После мержа автор убеждается, что все обязательные задачи (конфигурация, секреты, мониторинг) выполнены до выката.

## Чек-лист требований

### Общие принципы архитектуры
- **Минимизация поверхности атаки**
  - *Проверить:* новые публичные конечные точки, открытые порты, флаги конфигурации по умолчанию, отключение тестовых/диагностических роутов.
  - *Красные флаги:* публичные debug-эндпоинты, wildcard CORS/CSRF, экспорт внутренних метрик без аутентификации.
- **Принцип наименьших привилегий**
  - *Проверить:* объём прав сервисных аккаунтов, БД-ролей, файловых разрешений, ограничение системных команд.
  - *Красные флаги:* использование admin-ролей, `sudo`/`root` внутри приложений, доступ к общим секретам, неограниченный доступ к очередям/шинам данных.
- **Безопасные значения по умолчанию**
  - *Проверить:* новые конфиги, feature-flags, fallback-ветки логики, поведение при ошибках.
  - *Красные флаги:* включённые по умолчанию небезопасные режимы, `allowAll=true`, пропуск проверки при таймауте.
- **Обработка ошибок и технические детали**
  - *Проверить:* что исключения не раскрывают детали инфраструктуры, ключей, SQL-запросов, стек-трейсов в проде.
  - *Красные флаги:* возврат сырого `Exception`, утечка конфигурации в JSON-ответах, логирование секретов.

### Идентификация, аутентификация и сессии
- **Надёжная аутентификация**
  - *Проверить:* все новые входные точки требуют авторизации, отсутствуют обходы (публичные маршруты, `skip_auth`).
  - *Красные флаги:* отключение MFA, fallback на гостевой доступ, жёстко прошитые пароли.
- **Управление сессиями и токенами**
  - *Проверить:* время жизни, ротацию, привязку к устройству/IP, защиту от повторного воспроизведения.
  - *Красные флаги:* бессрочные токены, хранение токена в `localStorage` без доп. защиты, отсутствие проверки `aud`/`iss`.
- **Хранение и проверка паролей**
  - *Проверить:* использование современных алгоритмов (bcrypt/argon2/scrypt), наличие салта, ограничение попыток.
  - *Красные флаги:* `MD5/SHA1`, кастомные домашние реализации, отсутствие rate limit.

### Авторизация и контроль доступа
- **Матричная проверка прав**
  - *Проверить:* привязку проверок к доменным действиям, проверку прав как на чтение, так и на модификацию.
  - *Красные флаги:* проверка только в интерфейсе, отсутствие серверной валидации ролей.
- **Мульти-тенант изоляция**
  - *Проверить:* фильтрацию по tenant-id/организации, использование контекста в запросах.
  - *Красные флаги:* отсутствие фильтров, использование глобальных кэшированных списков без scoping.
- **Повышение привилегий и эскалация**
  - *Проверить:* что переходы на роль администратора требуют повторной авторизации/подтверждения.
  - *Красные флаги:* возможность изменить роль через клиент, отсутствие аудита действий с ролями.

### Валидация и нормализация входных данных
- **Жёсткая валидация схемы**
  - *Проверить:* применение серверных схем (pydantic/DRF serializers/заводские структуры), отказ по умолчанию.
  - *Красные флаги:* доверие данным клиента, использование `eval`, динамических SQL без parametrized запросов.
- **Защита от инъекций**
  - *Проверить:* использование параметризованных запросов, ORM, экранирование в шаблонах.
  - *Красные флаги:* строковая конкатенация SQL, формирования команд для shell без безопасной обёртки.
- **Фильтрация/кодирование вывода**
  - *Проверить:* экранирование HTML, URL, использование CSP/санитайзеров для rich-text.
  - *Красные флаги:* вывод непроверенного HTML, сохранение пользовательского JS, отсутствие `escape`.

### Безопасное хранение данных и конфиденциальность
- **Контроль над чувствительными данными**
  - *Проверить:* классификацию данных, отдельные схемы/таблицы для PII, минимизацию собираемых полей.
  - *Красные флаги:* логирование PII, хранение в нешифрованных столбцах, отсутствие маскирования.
- **Шифрование на хранении**
  - *Проверить:* использование TDE или приложенческого шифрования, управление ключами через KMS.
  - *Красные флаги:* собственные алгоритмы, ключи в коде, общий master-key для всех клиентов.
- **Резервное копирование и удаление**
  - *Проверить:* что бэкапы/дампы защищены и удаляются по политике, данные удаляются по GDPR/152-ФЗ требованиям.
  - *Красные флаги:* открытые S3-бакеты, бессрочные бэкапы в общем доступе.

### Управление конфигурацией и секретами
- **Секреты вне кода**
  - *Проверить:* отсутствуют ключи, токены, пароли в репозитории, CI переменные настроены через vault/secret manager.
  - *Красные флаги:* добавление `.env`, `config.json` с секретами, `Base64`-секреты в миграциях.
- **Разделение окружений**
  - *Проверить:* конфиги для dev/stage/prod разнесены, прод-настройки не попадают в тестовый код.
  - *Красные флаги:* использование продовых секретов в тестах, объединённые `.env`.
- **Ротация и отзыв**
  - *Проверить:* документы описывают ротацию, код предусматривает отзыв ключей и graceful degrade.
  - *Красные флаги:* отсутствие механизмов отзыва сертификатов/токенов.

### Коммуникации, API и внешние интеграции
- **Шифрование в транзите**
  - *Проверить:* использование HTTPS/TLS1.2+, проверка сертификатов, запрет на plain HTTP.
  - *Красные флаги:* `verify=False`, downgrade до http, собственные cipher suites.
- **Ограничение внешних запросов**
  - *Проверить:* контроль списка разрешённых хостов, защита от SSRF, таймауты и лимиты.
  - *Красные флаги:* проксирование запросов клиента без фильтрации, возможность обращаться к метаданным облака.
- **Версионирование и контракты**
  - *Проверить:* документация API, совместимость схем, валидация ответов внешних сервисов.
  - *Красные флаги:* слепое доверие внешним payload, отсутствие обработки ошибок.

### Работа с файлами и пользовательским контентом
- **Безопасная загрузка файлов**
  - *Проверить:* ограничения по типу/размеру, вирусная проверка, изоляция хранения.
  - *Красные флаги:* сохранение исполняемых файлов, отсутствие проверок MIME/расширения.
- **Обработка пользовательского HTML/Markdown**
  - *Проверить:* санитайзеры, allowlist-теги, запрет скриптов и inline-стилей.
  - *Красные флаги:* прямой рендер Markdown -> HTML без фильтра.
- **Путь и доступ к файловой системе**
  - *Проверить:* использование безопасных путей, запрет `../`, отсутствие записи в системные директории.
  - *Красные флаги:* генерация путей строками, работа с абсолютными путями от пользователя.

### Логирование, аудит и мониторинг
- **Содержимое логов**
  - *Проверить:* маскирование PII/секретов, отсутствие токенов и паролей, использование унифицированных форматов.
  - *Красные флаги:* `print` секретов, хранение логов в открытом доступе.
- **Аудит действий**
  - *Проверить:* что значимые события (логин, изменение ролей, доступ к критичным данным) логируются с контекстом.
  - *Красные флаги:* отсутствие аудита для административных операций.
- **Алертинг и метрики**
  - *Проверить:* новые метрики/алерты на повторяющиеся ошибки, превышение лимитов, подозрительные паттерны.
  - *Красные флаги:* отсутствие мониторинга для критичных путей, отключение существующих алертов.

### Управление зависимостями и поставками
- **Обновления и версии**
  - *Проверить:* минимальные версии зависимостей, отсутствие устаревших библиотек с известными CVE.
  - *Красные флаги:* пин на уязвимую версию, ручное отключение `pip-audit`/`npm audit`.
- **Проверка источников**
  - *Проверить:* зависимости из официальных репозиториев, наличие хешей, запрет на установки из приватных URL без верификации.
  - *Красные флаги:* `pip install` из непроверенного gist, использование curl|bash.
- **Артефакты сборки**
  - *Проверить:* воспроизводимость билдов, хранение артефактов в доверенных реестрах.
  - *Красные флаги:* ручные правки собранных пакетов, загрузка бинарей в репозиторий.

### Криптография
- **Использование проверенных библиотек**
  - *Проверить:* обращения к стандартным библиотекам, отсутствие самодельных алгоритмов.
  - *Красные флаги:* прямое использование `java.security.SecureRandom` без инициализации, домашние реализации AES.
- **Управление ключами**
  - *Проверить:* хранение ключей в KMS/HSM, разделение ключей по окружениям и сервисам.
  - *Красные флаги:* ключи в коде, передача через переменные окружения без шифрования при деплое.
- **Протоколы и форматы**
  - *Проверить:* актуальные версии TLS, JWT с `alg` != `none`, корректные параметры X25519/EC.
  - *Красные флаги:* `RSA<2048`, `ECB`, `JWT` без подписи.

### Инфраструктура и развёртывание
- **Контейнеры и образы**
  - *Проверить:* использование минимальных базовых образов, список пакетов, отсутствие root-процессов.
  - *Красные флаги:* запуск контейнера от root, открыт весь `/var/run/docker.sock`.
- **CI/CD пайплайны**
  - *Проверить:* права runner'ов, фильтрацию секретов, отсутствие команд из внешних MR без review.
  - *Красные флаги:* `curl | sh` в пайплайнах, глобальные токены с правами admin.
- **Конфигурация окружений**
  - *Проверить:* terraform/ansible/playbooks на наличие открытых правил в firewall, правил для SSH.
  - *Красные флаги:* `0.0.0.0/0` в прод, отключённые обновления безопасности.

### Процессы разработки и тестирования
- **Покрытие тестами сценариев безопасности**
  - *Проверить:* наличие unit/интеграционных тестов на негативные сценарии (неверные роли, лимиты).
  - *Красные флаги:* отсутствие тестов при правках критичных путей, комментарии `# nosec` без обоснования.
- **Статический и динамический анализ**
  - *Проверить:* результаты `ruff`, `bandit`, `mypy`, `pip-audit`, дополнительные SAST/DAST отчёты.
  - *Красные флаги:* отключение анализаторов, игнорирование известных предупреждений.
- **Документация по безопасности**
  - *Проверить:* обновление threat model, runbooks, схем данных.
  - *Красные флаги:* отсутствие описания миграций, повышающих уровень доступа.

### Реагирование на инциденты и наблюдаемость
- **Готовность к инцидентам**
  - *Проверить:* наличие runbook для новых компонентов, контактов on-call.
  - *Красные флаги:* неочевидные ручные шаги без инструкций.
- **Детектирование аномалий**
  - *Проверить:* что события (неудачные логины, частые запросы, превышения лимитов) видны в мониторинге.
  - *Красные флаги:* полное отключение rate limiting/alerting.
- **Коммуникации и уведомления**
  - *Проверить:* интеграции с incident-каналами, корректные уровни алертов.
  - *Красные флаги:* рассылка чувствительных данных по e-mail без шифрования, отсутствие уведомлений для критичных событий.

## Согласование отступлений
Любые отступления от требований фиксируются в MR/PR с описанием причины, срока устранения и ответственного. Security Champion утверждает исключение и заносит задачу в бэклог.

## Поддержка и актуализация документа
Документ пересматривается не реже одного раза в полугодие или после инцидента. Предложения по улучшению отправлять через MR в раздел `docs/`.
