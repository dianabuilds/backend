# Видение раздела модерации

## Цели и роли
- Обеспечить единую рабочую среду для команд модерации, поддержки и администрирования контента.
- Сократить время реакции на инциденты (контент, пользователи, кейсы) и сделать решения воспроизводимыми.
- Встроить контроль доступа по ролям (Admin, Moderator, Editor) через существующие scope'ы moderation:*.
- Создать прозрачные журналы действий и историю решений для аудита.

## Общие принципы UX и архитектуры
- Единый шаблон страницы: заголовок, фильтры, таблица/карточки, вторичная панель с деталями (drawer).
- Сохранённые фильтры/представления (локально) и быстрые пресеты для типовых очередей.
- Универсальные состояния загрузки/ошибок/пустой выборки, возможность ручного Refresh и автообновления (polling/WebSocket при готовности).
- Контекстные быстрые действия (кнопки на строках) + подробные решения внутри правого дроуэра.
- Ссылки между сущностями: из кейса открыть контент, из контента — автора, из санкции — апелляцию.
- Лента активности и журнал изменений для каждой сущности (действия, автор, время, причины).

## Ключевые сущности и данные
| Сущность | Назначение | Основные поля | Источники данных | Роли | API |
| --- | --- | --- | --- | --- | --- |
| Обзор (OverviewDTO) | Дашборд нагрузки | очередность контента, кейсов, свежие санкции, карточки "action items" | service.overview + агрегаты БД/аналитики | Admin, Moderator, Editor | GET /api/moderation/overview |
| Пользователь (UserSummary/UserDetail) | Профиль, санкции, заметки | идентификаторы, роли, статус, жалобы, санкции, тикеты, заметки, активность | user-service, moderation-service | Admin, Moderator (полный доступ), Editor (без санкций) | GET /api/moderation/users, GET /users/{id}, POST/DELETE для ролей/санкций/заметок |
| Контент (ContentSummary) | Очереди контента и решения | тип, превью, статус, AI метки, история решений, связанные жалобы | контент-хранилище, feature store, AI | Admin, Moderator, Editor | GET /api/nodes/library, POST решения |
| Кейс модерации (ModerationCaseDTO + ReportDTO/TicketDTO/AppealDTO) | Единая точка работы с жалобами, апелляциями и эскалациями | type (report/appeal/ticket), subject (user/content/sanction), очередь, приоритет, SLA, связанный контент/пользователи, история действий, вложения, internal notes | reporting-service, appeals-service, helpdesk/tickets, moderation-service | Admin, Moderator (ведение), Editor (валидация/комментарии) | GET /api/moderation/cases (filters: type,status,severity), GET /cases/{id}, POST /cases/{id}/actions (resolve, escalate, convert), POST /cases/{id}/notes |
| AI Rule (AIRuleDTO) | Настройка автоматической модерации | категории, пороги, действия, история | AI rules store | Admin (запись), Moderator (чтение), Editor (чтение) | GET /api/moderation/ai-rules, POST/PATCH |
| Санкция (SanctionDTO) | Меры воздействия | тип, срок, причина, статус, доказательства | moderation-service | Admin, Moderator | составные эндпоинты пользователей/контента |

## Страницы и сценарии

### 1. Обзор
- **Цель:** быстрый статус платформы и задачи первой очереди.
- **Карточки KPI:** количество активных кейсов/апелляций/эскалаций, SLA, тренды (спарклайны по часам/дням).
- **Лента событий:** последние санкции/решения (тип, объект, модератор, время, ссылка на сущность).
- **Action cards:** CTA для "Назначить ответственного", "Проверить очередь AI" и т.п. (используем `cards` из DTO).
- **Графики:** распределение жалоб по категориям, температура очередей. Источник — агрегирующий сервис + кэш.
- **Интерактив:** фильтрация по продукту/региону, переключение между режимами модерации (контент, кейсы, AI).

### 2. Кейс-центр (Cases)
- **Цель:** обеспечить команде модерации triage и полноценную работу с каждым обращением (report/ticket/appeal) в едином интерфейсе.
- **Основные сценарии:** поиск и фильтрация по статусу, типу, очереди, исполнителю, приоритету и тегам; быстрое назначение; переключение статуса/очереди; просмотр последних событий; переход в полноценный режим работы.
- **Роль карточки/дроуэра:** быстрый просмотр для triage прямо из списка; основные правки (assign, статус, заметка) без выхода из списка; вся глубокая работа — на отдельной странице.
- **Композиция страницы:**
  - Фильтры в верхней панели (поиск по id/subject/title, multi-select статусов/типов/очередей, Assignee, Severity, Priority, теги, диапазон дат).
  - Quick stats над таблицей: счётчики открытых/просроченных кейсов, backlog по очередям, кнопка Refresh.
  - Таблица с колонками ID, Заголовок, Subject, Тип, Severity, Queue, Priority, Assignee, Updated/SLA, Теги; адаптивное скрытие второстепенных колонок на узких экранах.
  - Preview drawer справа для выбранного кейса.
  - Open case ведёт на маршрут /moderation/cases/:id.
- **Карточка кейса (drawer):**
  - Шапка: ID + заголовок, бейджи статуса/severity/priority, время последнего обновления и SLA.
  - Контекст: subject (тип, label, ссылка на /moderation/users или /nodes/library), тип кейса, источник, очередь, теги, AI сигналы, связанные сущности (links).
  - Назначение: текущий исполнитель, очередь, watchers (плейсхолдер), быстрые действия Assign to me, Change status, Change queue, Add note.
  - Последние события: последние 3 элемента из timeline (events + notes) с CTA View full timeline.
  - Заметки: последняя pinned note и кнопка Add internal note.
- **Полноценная страница кейса /moderation/cases/:id:**
  - Двухколоночный layout: центральный поток (Summary, Conversation/Notes, Timeline) и боковая панель атрибутов.
  - Секции: Summary (атрибуты кейса, metadata, subject preview, вложения), Conversation (internal notes + задел под чат/почту), Timeline (все события с фильтрами), Attachments (файлы, ссылки).
- **Коммуникация:** раздел `Conversation` делится на вкладки `Internal` и `Customer`. Внутри отображаем ленту сообщений по образцу чата (аватар, имя, метка времени, статус доставки). Для внешних ответов используем шаблоны и быстрые действия (`Send preset`, `Request context`, `Close with message`); такие сообщения уходят через helpdesk/почтовый шлюз. Внутренние записи хранятся как notes, наружные помечаются `visibility: external` и дублируются в timeline. Запланировано подключение WebSocket, чтобы модераторы в реальном времени видели входящие ответы пользователя.
  - Панель действий: изменение статуса/очереди/приоритета/severity, назначение исполнителя, Assign to me, Resolve, Escalate, Convert to ticket (заглушки).
  - Показ ссылок (links), отображение SLA (время в статусе, дедлайн), блок pinned notes.
- **Технические заметки:**
  - Использовать API /api/moderation/cases, /api/moderation/cases/{id}, /api/moderation/cases/{id}/notes (list/detail/mutations).
  - Разделить реализацию на модули: CasesPage, CaseFilters, CaseTable, CaseRow, CasePreviewDrawer, CaseSummaryCard, CaseTimeline, CaseDetailPage.
  - Сохранять фильтры в URL (?status=open&queue=general) и кэшировать локально (localStorage) для пресетов.
  - Drawer открывать по query "?case={id}"; кнопка Open case ведёт на /moderation/cases/${id}; предусмотреть прямой переход по /moderation/cases/:id.
  - Состояния загрузки/ошибок/skeleton; ручной Refresh + подготовка к последующему polling/WebSocket.
  - Плейсхолдеры для вложений и внешнего диалога (пока используем notes как историю общения).

### 3. Пользователи
- **Список:** таблица с поиском по id/email/username, фильтры по статусу, ролям, санкциям, количеству жалоб.
- **Индикаторы:** бейдж активных санкций, флаг "под наблюдением", счётчики тикетов/заметок.
- **Дроуэр профиля:** вкладки `Сводка`, `Санкции`, `Жалобы`, `Апелляции`, `Тикеты`, `Заметки`. Журнал действий.
- **Управление ролями:** ограничено Admin; записи через POST/DELETE, audit trail.
- **Санкции:** шаблоны (предупреждение, временный бан, бессрочный) с предзаполненными сроками, поле для причины, чеклист доказательств.
- **Заметки:** быстрые заметки (пин), назначение внутренних тегов/категорий.
- **Связи:** ссылки на контент пользователя, переход в кейс или апелляцию.

### 4. Контент
- **Типы и очереди:** верхний переключатель `Nodes / Quests / Worlds` + табы статусов (Pending/Hidden/Restricted/Escalated/Resolved). Каждый выбор типа сохраняет собственные фильтры (язык, продукт, AI label, severity) и метрики SLA.
- **Список:** универсальная таблица с колонками `ID`, `Тип`, `Название/превью`, `Автор`, `Очередь`, `AI`, `Последнее действие`, `SLA`. Для Nodes отображаем короткий текст и количество жалоб; для Quests — этап/продолжительность и связанных узлов; для Worlds — ключевые показатели мира (видимость, размер, владельцы).
- **Канбан/сетка:** для Worlds предусмотрена альтернатива таблице — карточки мира по статусам, чтобы быстрее видеть большие кейсы. Переключение режима (таблица/карточки) сохраняется локально.
- **Дроуэр решения:** вкладки `Контент`, `Жалобы`, `Связи`, `История`, `Действия`. Для Nodes показываем превью и связанные квесты/миры, для Quests — структуру шагов, для Worlds — карту мира и ключевые метрики. Есть кнопка "Открыть в редакторе"/"Открыть страницу" для глубокого редактирования.
- **Действия:** keep/hide/delete/restrict/escalate + типовые шаблоны санкций. Для Quests возможна заморозка/откат версии; для Worlds — ограничение новой публикации и уведомление владельцев.
- **Быстрые действия:** на строках Nodes доступно мгновенное скрытие (иконка) без открытия дроуэра, чтобы ускорить triage. Для Quests/Worlds быстрые действия — "Поставить на ревью", "Назначить".
- **Bulk:** массовые решения для однотипных элементов в рамках выбранного типа (например, скрыть группу нод или пометить квесты как resolved). Валидация предупреждает, если выбраны смешанные типы.
- **Навигация и связи:** кнопка "Создать кейс" связывает элемент с модерационным кейсом (жалобой/тикетом). Из дроуэра можно перейти к пользователю или открыть карту мира. После применения решения отображается блок с рассылкой уведомления и ссылкой на аудит.

### 5. Кейс-центр (Reports / Appeals / Tickets)
- **Зачем объединять:** жалобы, апелляции и эскалационные тикеты — разные грани одной работы с кейсами. Единый список уменьшает когнитивную нагрузку, упрощает обучение и ускоряет маршрутизацию.
- **Единый список:** базовая таблица с колонками `Тип`, `Объект`, `Источник`, `Приоритет`, `SLA`, `Назначен`, `Статус`, `Новые сообщения`. Фильтры по типу, очереди, продукту, тегам, срочности.
- **Лейаут:** универсальный дроуэр с вкладками `Обзор`, `Переписка/Комментарий`, `История`, `Связанные сущности`, `Действия`. Последняя вкладка предлагает допустимые операции в зависимости от типа.
- **Типы кейсов:**
  - `Report`: входящие жалобы пользователей. Доп. поля — категория, количество репортов, AI-оценка. Доступные действия: валидация (valid/invalid), эскалация в контент или тикет, выдача санкции.
  - `Appeal`: запрос пересмотра санкции. Доп. поля — текущий статус санкции, шаблоны ответов. Действия: подтвердить, отменить, смягчить санкцию, запросить информацию.
  - `Ticket`: внутренняя эскалация/диалог. Доп. поля — сообщения (внешние/внутренние), чеклист задач, ответственный. Действия: назначить, добавить комментарий, закрыть/эскалировать дальше.
- **Сценарии перехода:** из жалобы можно создать тикет или прикрепить к существующему; из тикета — инициировать санкцию или передать в апелляцию; апелляцию можно вновь открыть как тикет при сложных кейсах.
- **Очереди:** пресеты для `Новые`, `Скоро просрочатся`, `Высокий приоритет`, `Мои кейсы`, `AI эскалации`. Сохранение пользовательских вью.
- **Коммуникация:** встроенный редактор шаблонов ответов, лог внутренних заметок, возможность упоминания коллег.
- **Аудит:** каждая операция фиксируется с указанием типа кейса, действия, автора, комментария; доступен экспорт.
- **Навигация:** основной маршрут `/moderation/cases`; быстрые ссылки формата `/moderation/cases/{id}` с автофокусом на нужной вкладке.

### 6. Правила ИИ (AI Rules)
- **Категории:** список правил по видам нарушений (toxicity, spam, nudity...).
- **Параметры:** editable поля порогов (score), действий (auto-hide, auto-flag, escalate), границы уверенности.
- **Предпросмотр:** показываем, сколько контента будет попадать под новое правило (статистика за период).
- **История версий:** лог изменений с автором, датой, комментарием; возможность отката.
- **Безопасность:** редактирование только Admin, для Moderator/Editor — read-only.

## Межстраничные связи и навигация
- Breadcrumbs и быстрые ссылки из лент (например, из последней санкции > профиль пользователя).
- Общий поиск по moderation (команда + Ctrl+K) с переключением `Content`, `Users`, `Cases`, `AI`.
- Набор коротких URL для быстрой вставки в коммуникации (`/nodes/library/{id}`, `/moderation/users/{id}`, `/moderation/cases/{id}`).

## Требования к данным и интеграциям
- Отказоустойчивый кэш/реплика для чтения (нагрузка на агрегирующие запросы минимальная).
- Обновление очередей не реже 30 секунд (polling) с плавной деградацией.
- Логирование всех write-операций (санкции, решения, правки AI, действия по кейсам) в audit trail с user_id, scope, payload.
- Нотификации: вебхуки/почта/Slack для эскалаций и просрочек.
- Поддержка многоязычности в причинах и шаблонах коммуникаций.

## План внедрения (итерации)
1. **MVP:** завершить API/фронт для Overview, Users (read + санкции/заметки), Content (решения) и базовый Кейс-центр (Reports как `type=report`, единый дроуэр, действия validate/resolve/escalate).
2. **Расширение:** добавить в Кейс-центр апелляции и внутренние тикеты (сообщения, назначение, SLA), улучшить дашборд с графиками.
3. **Автоматизация:** Bulk-действия, связи между сущностями, уведомления, единый audit trail UI, конвертация типов кейсов.
4. **AI & аналитика:** полный раздел AI Rules с предпросмотром, A/B тест правил, алерты по всплескам нарушений.

## Метрики успеха
- SLA по кейсам (90% < 24ч, таргет).
- Среднее время до решения контента (MTTR).
- Количество ошибочных санкций (по апелляциям) — снижение.
- Удовлетворённость модераторов (опрос/feedback) и количество ручных переключений между инструментами.

