# ADR-001: Унификация идентификаторов (tenant_id) и смыслов "scope"

Дата: 2025-09-11

## Контекст

В кодовой базе параллельно используются разные идентификаторы и термины:

- workspace_id, tenant_id, account_id — как идентификаторы области/организации.
- profile_id — владелец контента (персональная область).
- user_id — актор, выполняющий действие.
- "scope" перегружен: в метриках (label для агрегации), в квотах/лимитах (временное окно), в фильтрах листинга (mine/global).

Это снижает консистентность и повышает сложность сопровождения.

## Решение

1) Каноническое имя идентификатора арендатора: `tenant_id`.
   - `workspace_id` и `account_id` объявляются устаревшими (deprecated).
   - Период совместимости: резолверы принимают оба, но логируют предупреждение.

2) Роли идентификаторов:
   - `tenant_id` — границы доступа/изолированная область (организация/пространство).
   - `profile_id` — владелец контента (персональные артефакты, профиль-центричная логика).
   - `user_id` — актор, кто инициирует действие.

3) Разгрузка "scope":
   - В квотах/лимитах: `period` или `window` (например, day|month).
   - В метриках HTTP/ивентов: `tenant_label`/`profile_label` вместо абстрактного `scope`.
   - В листингах (nodes): `scope_mode` (mine|global) оставить, явно документировать.

4) API-резолверы:
   - Введён единый `get_tenant_id()` в `app/api/deps.py`.
   - Поддерживает `tenant_id` и устаревший `workspace_id` из query/path (`account_id` в path тоже поддерживается как alias).

5) Миграции БД (этап 1):
   - Добавляем столбцы `tenant_id` рядом с `workspace_id` в ключевых таблицах (quests, event_quests, purchases, progress, audit_logs, outbox).
   - Заполняем значениями из `workspace_id`.
   - Создаём индексы и (при возможности) FK на `workspaces.id`.
   - Код постепенно переводится на `tenant_id`.
   - Удаление `workspace_id` — отдельным релизом после стабилизации.

6) Worlds-домен:
   - Профиль-центричная модель (WorldTemplate/Character — `profile_id`).
   - Репозиторий будет приведён в соответствие модели (убрать обращения к `workspace_id`).

## Миграционная стратегия

1. Релиз A: добавить `tenant_id`, бэкофис принимает оба параметра, логи предупреждают об использовании `workspace_id`.
2. Релиз B: код всех доменов переходит на `tenant_id`, SDK/клиенты обновлены; метрики/квоты получают новые имена лейблов и ключей.
3. Релиз C: удалить `workspace_id` из схемы и параметров API.

## Влияние на тесты и инструменты

- Фикстуры и клиенты — переход на `tenant_id`; временно дублировать кейсы с обоими параметрами в критичных сценариях.
- Линт/прекоммит: запрет на новые упоминания `workspace_id`/`account_id` (кроме миграций и модели `workspaces`).

## Альтернативы

- Сохранить `workspace_id` как канон — отвергнуто: хуже отражает смысл (арендатор), уже есть смешение с `account_id`.

## Риски

- Разрыв клиентов — смягчается периодом совместимости и логированием.
- FK/типизация для разных СУБД — минимизируется через пошаговые миграции и бэкофисный фолбэк на `create_all()` в dev/test.

