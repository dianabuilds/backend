# Инвентаризация и аудит API-контуров

Документ фиксирует состав артефактов и рабочие соглашения по инвентаризации текущих API. Цель — поддерживать актуальный список эндпоинтов, клиентов и рисков, чтобы готовить и контролировать разделение на публичный, административный и операционный контуры.

## Область и цели

- собрать 100 % действующих маршрутов по сервисам с указанием контуров, ролей и критичности данных;
- описать связи между клиентами, API, хранилищами и интеграциями;
- зафиксировать риски и быстрые исправления (quick wins), на которые нужно реагировать в первую очередь;
- синхронизировать результаты с ADR `../../adr/2025-10-19-api-segmentation.md` и планом работ по сегментации.

## Артефакты каталога `docs/reference/api/`

| Файл | Что содержит | Ответственный |
|------|--------------|----------------|
| `catalog.md` | Таблица сервисов и эндпоинтов с колонками `Service`, `Endpoint`, `Method`, `Client`, `Contour (target)`, `Auth type`, `Required role/scope`, `Data sensitivity`, `Dependencies`, `Known issues`, `Priority`. | Архитектор/тимлид домена |
| `access-policy.md` | Матрица ролей, привязка контуров и политик доступа. | Архитектор + Security |
| `findings.md` | Выявленные риски, quick wins, журнал проверок. | Исполнитель аудита |
| `network-architecture.md` + `network-architecture.svg` | Описание и диаграмма сетевых зон, шлюзов, сервисов и хранилищ. | DevOps |
| `system-map.svg` | Визуальная карта «клиенты ↔ API ↔ БД/интеграции». | Архитектор |
| `pre-migration-actions.md` | Чек-листы и последовательность шагов перед миграцией ручек между контурами. | Технический лидер |
| `secret-playbook.md` | Процедуры работы с секретами (INFRA‑5) и выгрузкой `.env`. | DevOps / Security |

## Готовность к старту (DoR)

- назначен владелец аудита, согласован стек инструментов (Swagger, router dump, анализ кода);
- подтверждён доступ к репозиторию, конфигурациям маршрутизации и актуальным спекам;
- утверждены шаблоны артефактов из таблицы выше;
- определён состав ревьюеров (безопасность, бэкенд, DevOps) и формат синхронизаций.

## Готовность результата (DoD)

- `catalog.md` заполнен по всем сервисам, указаны контуры, клиенты, риски и уровни доступа;
- диаграммы сети и системы обновлены и согласованы с DevOps/Security;
- `findings.md` содержит список рисков с приоритетами и ссылками на quick wins;
- результаты презентованы заинтересованным сторонам, ссылки добавлены в ADR `../../adr/2025-10-19-api-segmentation.md`.

## Acceptance Criteria

1. Таблица охватывает все актуальные публичные, административные и фоновые маршруты; для каждого маршрута указаны метод, путь, владелец, чувствительность данных, требуемая роль и механизм авторизации.
2. Для каждого сервиса перечислены клиенты (web, mobile, cron, интеграции), протоколы, точки входа и используемые базы/шины данных.
3. Каждый риск классифицирован (высокий/средний/низкий) и сопровождается рекомендуемым действием.
4. Команды безопасности и DevOps подтвердили корректность артефактов; комментарии отражены в итоговом отчёте.

## Локальный запуск контуров

- `backend-public` — порт `8010`, профили `local/dev`, контур `public` для пользовательских сценариев и фронтенда. Запуск: `docker compose --profile local up backend-public` (PostgreSQL/Redis/MinIO поднимутся как зависимости).
- `backend-admin` — порт `8011`, профили `local/dev`, контур `admin` для модераторов и админ-панели. Запуск: `docker compose --profile local up backend-admin`.
- `backend-ops` — порт `8012`, профили `local/dev`, контур `ops` для высокорисковых операций (финансы, системные настройки). Запуск: `docker compose --profile local up backend-ops`.
- Для локальной разработки без Docker Compose доступны `make run-public`, `make run-admin`, `make run-ops` (параметры проксируются в `apps/backend/Makefile`, выставляются `APP_API_CONTOUR`, `APP_PORT`, `UVICORN_HOST/PORT`). Цель `make run` помечена как legacy и подсказывает перейти на именованные контуры. Есть короткий alias `make docker-local-backend-<contour>` для запуска конкретного сервиса через Docker Compose.

Все сервисы используют общие переменные окружения `APP_API_CONTOUR`, `APP_PORT`, `UVICORN_HOST` (см. `.env`, `apps/backend/.env`). Проверить конфигурацию можно командой `docker compose --profile local config`, активные контейнеры — `docker compose --profile local ps`.
