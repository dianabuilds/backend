# ADR 2025-10-02 — Расширение функционала нод: просмотры, реакции, комментарии

## Контекст

- Текущая модель `nodes` хранит базовые поля: `id`, `author_id`, `slug`, `title`, `is_public`, статусы публикации, `content_html`, `cover_url`, `embedding`.
- В функционале отсутствуют счётчики просмотров, реакции и комментарии. Пользовательский опыт ограничивается публикацией и редактированием контента.
- Роли: `user`, `support`, `moderator`, `admin`. Гости могут только читать. Автор ноды должен иметь возможность управлять комментариями под своей нодой, модераторы/админы — обходить любые ограничения.
- Требуется обеспечить аналитику (просмотры), социальное взаимодействие (лайки), обсуждение (дерево комментариев), а также операции модерации (бан пользователей, блок комментариев).

## Решение

1. **Данные и миграции**
   - Добавляем колонку `nodes.views_count` и таблицу `node_views_daily` для агрегации просмотров по датам.
   - Создаём таблицу `node_reactions` с уникальным лайком на пользователя и агрегатом `nodes.reactions_like_count`.
   - Вводим систему комментариев: таблица `node_comments` с деревом через `parent_comment_id`, таблица `node_comment_bans`, флаг `nodes.comments_disabled`, поля `comments_locked_by`, `comments_locked_at`.
2. **Сервисы и бизнес-логика**
   - Реализуем сервисы для просмотров (с дедупликацией), реакций (идемпотентные лайки), комментариев (создание, удаление, блокировки, баны, статусы).
   - Обновляем `NodeService`/новые сервисы, расширяем DTO `NodeDTO`/`NodeView` полями engagement.
   - Публикуем события в outbox для аналитики и уведомлений (`node.viewed`, `node.reaction.created/deleted`, `node.comment.created/deleted`, `node.comments.locked`).
3. **API**
   - Расширяем REST API `/v1/nodes`: эндпоинты для просмотров, лайков, списка/создания/удаления комментариев, блокировки комментариев и банов пользователей.
   - Возвращаем в `GET`-ответах поля `views_count`, `reactions_like_count`, `comments_disabled`, `comments_locked_by/at`, ссылку на комментарии.
   - Предусматриваем модераторские маршруты в `admin_http.py`.
   - Опционально предоставляем live-обновления (WebSocket/SSE).
4. **Тестирование и качество**
   - Юнит, интеграционные, E2E тесты для новых сервисов и API, включая сценарии ролей и нагрузочные проверки.
   - Обновляем `docs/playbooks/backend-testing.md`, создаём QA чек-листы и фикстуры.
5. **Роли и правила доступа**
   - Гости не комментируют и не ставят лайки.
   - Автор ноды может заранее отключить комментарии, блокировать отдельных пользователей, удалять комментарии под своей нодой.
   - Модераторы/админы действуют без ограничений, могут разблокировать, просматривать скрытые комментарии, снимать баны.

## Фронт/Админка

### Карточка ноды
- Отображать текущие счётчики просмотров и лайков, статус комментариев (включены/заблокированы, число скрытых/ожидающих).
- Добавить действия для модерации: `Заблокировать`, `Отключить`, `Обновить статистику`; показывать дату последнего изменения карточки.
- Выводить ссылки на модерационные журналы (история блокировок, outbox-события) с открытием в новой вкладке.

### Комментарии
- Построить древовидный список с пагинацией (по веткам и по дате) и фильтрами по статусу (`active`/`pending`/`hidden`), авторам и интервалу времени.
- Для каждой записи предусмотреть быстрые действия: удалить/восстановить, сменить статус (`pending` <-> `hidden`), переход к родительскому комментарию и раскрытие цепочки.
- В шапке списка показывать индикатор блокировки комментариев и активных ограничений (троттлинг, баны).

### Баны и блокировки
- Создать экран со списком забаненных пользователей, включая инициатора, причину, дату и срок действия; добавить действия `Разбанить` и `Добавить бан`.
- Добавить виджет состояния: комментарии включены/выключены, глобальная блокировка, счётчик активных банов.

### Аналитика
- Визуализировать график просмотров по дням, суммарные лайки и распределение статусов комментариев (включая скрытые).
- Поддержать фильтры по диапазонам дат, авторам, сегментам и обеспечить экспорт текущего среза в CSV.
- Интегрировать с outbox-событиями для обновления статистики вблизи реального времени, указывать задержку агрегаций.

### Тесты и доступность
- Покрыть UI-компоненты юнит-тестами (Jest + Testing Library) и e2e-сценарии модератора (Cypress/Playwright), включая ветвление комментариев, баны и разблокировки.
- Провести A11y-аудит: таб-навигация, корректные ARIA-атрибуты, управление фокусом для модалок и меню действий.
- Добавить `data-testid`/`data-analytics` на ключевые контролы карточек, списков и графиков для QA и телеметрии.

## Альтернативы

- **Хранение просмотров только в Redis/аналитике**: проще, но нет консистентной исторической статистики и трудно строить отчёты. Отказано в пользу реляционной схемы + кэш.
- **Ликвидировать дерево комментариев** и оставить плоский список: упрощает реализацию, но ухудшает UX и невозможность отвечать на комментарии. Отказано.
- **Ограничиться только лайками без комментариев**: не решает задачу взаимодействия и модерации контента. Отказано.

## Последствия

- Потребуется поддерживать дополнительные таблицы и миграции, что увеличит нагрузку на БД и сложность кода.
- Необходимо внедрить кэширование/троттлинг для счётчиков во избежание гонок и нагрузки.
- Появится потребность в расширении UI и обучении модераторов/авторов новым сценариям управления комментариями.
- Тестовая и продакшн инфраструктуры должны поддерживать новые сервисы (Redis, очереди) и мониторинг (Prometheus/Grafana).

## Следующие шаги

1. Реализовать миграции БД и обновить DTO/репозитории.
2. Написать сервисы просмотров, реакций и комментариев с событиями outbox.
3. Расширить API и задокументировать новые контракты.
4. Обновить тесты, QA сценарии и мониторинг.
5. Спроектировать и внедрить функционал админки: карточка ноды, модерация комментариев, аналитика, UI-тесты и доступность.
