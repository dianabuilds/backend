# ADR: Редактор страниц и глобальных блоков

## Статус
Принято — 25.10.2025

## Контекст
- Редакторам и маркетингу не хватает единой точки, где можно найти и изменить все страницы (главная, справка, лендинги) и глобальные блоки (header, footer, промо‑виджеты).  
- Существующие инструменты разбросаны по меню, не поддерживают совместную работу, историю версий и зависимость страниц от общих блоков.  
- Уже есть частичная реализация редактора главной страницы (канвас блоков, предпросмотр, история), которую можно масштабировать.

## Решение
- В главном меню приложения появляется пункт «Редактор сайта», который открывает каталог страниц и глобальных блоков.  
- Каталог отображает карточки с названием, slug, статусом (draft/published/archived), датами, ответственным, быстрыми ссылками и поддерживает фильтры, поиск, сортировку.  
- Детальная карточка страницы включает список секций/блоков, журнал версий, действия «Редактировать», «Предпросмотр», «Опубликовать».  
- Редактор страниц расширяет текущий HomeEditor: канвас блоков, библиотека шаблонов, предпросмотр (desktop/mobile), автосохранение, работа как с локальными, так и с глобальными блоками.  
- Глобальные блоки редактируются централизованно: видно, где используются, есть предупреждения о влиянии, собственная история версий и публикация.  
- Версионность и процессы: черновики, поддержка статуса ревью (pending/approved/rejected) с возможностью self-approve для владельцев публикации, визуальный diff, комментарии и восстановление.  
- Роли и права управляют доступом к страницам/блокам и публикации. Ведётся полный audit log, доступен дашборд активности.  
- Интеграции: ссылки на продуктовые задачи, метрики страниц (просмотры, CTR); чек-листы и внешние уведомления отложены в бэклог.
- Перед стартом выполняем инвентаризацию существующих страниц/блоков и фиксируем стратегию миграции в общий каталог.  
- Для глобальных блоков храним список зависимых страниц и предупреждаем при публикации о массовых изменениях.  
- Для критичных страниц (главная, тарифы, header/footer) фиксируем требование отката ≤ 5 минут на основе версионирования; чек-лист переносим в отложенные задачи.

## Последствия
Плюсы:
- Единая точка управления контентом, меньше ручного вмешательства разработчиков.
- Прозрачная история изменений и возможность быстро откатиться.
- Управление глобальными блоками со знанием всех зависимостей.

Минусы/риски:
- Усложнение интерфейса, потребуется обучение и гайды.
- Необходимо расширение API и структуры данных (страницы, блоки, права).
- Требуются миграции существующих страниц/блоков в новый каталог.

## План реализации (по порядку)

### 1. Инвентаризация и миграционный план
- **Шаги:** собрать список страниц/блоков, классифицировать по типу и совместимости, определить стратегию миграции и приоритеты (см. `docs/site-editor-migration-plan.md`).  
- **Definition of Ready:** соглашение о форматах данных и доступ к текущим конфигам.  
- **Definition of Done:** таблица миграции в репозитории, стратегия по каждой странице, согласованный приоритет.  
- **Acceptance Criteria:** для любой страницы понятно, как и когда она перейдёт в новый редактор; нет незадокументированных исключений.

### 2. Архитектура данных и права
- **Шаги:** описать модели «страница/блок», расширить HomeConfig/HomeComposer, продумать схему прав и роли (см. `docs/site-editor-data-model.md`).  
- **DoR:** утверждён миграционный план, собраны требования к атрибутам страниц/блоков.  
- **DoD:** обновлённая спецификация моделей, черновик миграций, unit-тесты схем, описание ролей.  
- **AC:** документация отражает новые поля, роли и связи; схемы проходят валидацию тестами.

### 3. API каталога и версий
- **Шаги:** разработать эндпоинты списка страниц/блоков, деталей, истории версий и восстановления (см. `docs/site-editor-api.md`).  
- **DoR:** готовые модели из шага 2, утверждён формат ответов.  
- **DoD:** эндпоинты реализованы, покрыты тестами, задокументированы (OpenAPI).  
- **AC:** фронтенд может получить список с фильтрами, историю версий и выполнить восстановление через API.

### 4. Каталог страниц — backend
- **Шаги:** реализовать фильтры, сортировки, пагинацию на стороне сервера, учёт прав доступа.  
- **DoR:** эндпоинты из шага 3 готовы, определены поля фильтров.  
- **DoD:** фильтры работают, права проверяются, есть интеграционные тесты.  
- **AC:** запросы с фильтрами/пагинацией возвращают корректные данные без нарушения прав; роли без редакторских полномочий видят только опубликованные страницы и собственные черновики.

### 5. Каталог страниц — frontend
- **Шаги:** разработать UI списка, карточек страниц, поиск, отображение статусов и ответственных.  
- **DoR:** макеты и UX-флоу, готовые API (шаги 3–4), мок-данные.  
- **DoD:** реализован список, карточка страницы, e2e-тесты, документация.  
- **AC:** пользователь видит каталог, может фильтровать/искать, открывать карточку без ошибок.  
- **Результат:** UI доступен по `/management/site-editor`, покрыт e2e-сценарием `cypress/e2e/site_editor_catalog.cy.ts`, добавлено описание в `docs/site-editor-migration-plan.md`.

### 6. История и аудит — backend
- **Шаги:** сохранять версии страниц/блоков, реализовать diff и журнал действий, обеспечить откат.  
- **DoR:** модели и API базовой версии готовы, определён формат diff.  
- **DoD:** версии сохраняются, diff рассчитывается, откат работает, покрытие тестами.  
- **AC:** история хранит ≥10 версий, API возвращает diff, восстановление возвращает данные к предыдущему состоянию.

### 7. История и аудит — frontend
- **Шаги:** UI истории версий, визуальный diff, кнопки восстановления, отображение комментариев.  
- **DoR:** backend из шага 6 готов, макеты UI согласованы.  
- **DoD:** история отображается в карточке страницы и в редакторе, e2e-тесты восстановления.  
- **AC:** пользователь видит diff, может восстановить версию, UI отражает комментарии и метаданные.

### 8. Базовый редактор для всех страниц
- **Шаги:** адаптировать существующий HomeEditor к произвольным страницам, подключить каталожные данные, обеспечить автосохранение.  
- **DoR:** страницы доступны через API, определён минимальный набор блоков.  
- **DoD:** редактор открывается для любой страницы из каталога, работает автосохранение/ручное сохранение, тесты.  
- **AC:** пользователь может настроить блоки и сохранить черновик без ошибок.

### 9. Предпросмотр и UX улучшения редактора
- **Шаги:** добавить переключение макетов (desktop/mobile), визуальный diff, улучшенные валидаторы.  
- **DoR:** базовый редактор (шаг 8) готов, дизайн макетов утверждён.  
- **DoD:** просмотр переключается, валидаторы подсвечивают ошибки, diff отображает изменения, тесты.  
- **AC:** пользователь видит страницу в разных макетах, ошибки подсвечены, diff доступен из редактора.

### 10. Управление глобальными блоками
- **Шаги:** подготовить каталог глобальных блоков с фильтрами, поиском и счётчиками использования; добавить карточку зависимостей со ссылками на страницы и экспортом при больших выборках; доработать редактор для сохранения черновиков через `PUT /v1/site/global-blocks/{id}` и предупреждения о влиянии; реализовать подтверждаемую публикацию с перечнем затронутых страниц и уведомлениями; подключить вкладку истории версий с diff и восстановлением (см. `docs/site-editor-api.md`, раздел 3).  
- **DoR:** шаги 7–9 завершены, канвас редактора и история версий готовы к расширению; утверждён формат `usage` (id, slug, статус, локаль); согласованы поля аудита и тестовые данные для хедера, футера и промо‑блоков; подготовлены фикстуры RBAC по ролям `site.*`.  
- **DoD:** реализованы UI и API глобальных блоков (черновики, публикация, история), предупреждения и подтверждения покрыты UX-тестами; бэкенд фиксирует действия в `site_audit_log`, выполняет оптимистические проверки зависимостей; unit/интеграционные/E2E тесты закрывают сценарии редактирования → публикации → обновления страниц.  
- **AC:** в редакторе блока отображается полный список затронутых страниц со статусами и ссылками; публикация обновляет все зависимые страницы и создаёт запись аудита; вкладка истории фиксирует каждую версию, показывает diff и позволяет восстановить выбранную версию в актуальный черновик.

### 11. Библиотека блоков
- **Шаги:** зафиксировать и утвердить реестр `BlockDefinition` (см. `docs/site-editor-block-library.md`) с категориями, владельцами и поддерживаемыми страницами; описать JSON schema и адаптеры данных для каждого блока; реализовать каталог в UI с поиском, фильтрами по типам/источникам/владельцам и карточками с предпросмотром и документацией; подготовить формы настройки и валидацию для manual/auto/mixed источников данных с мок‑фидами и fallback; внедрить переключение локалей (RU/EN) с локализованными полями и fallback; обновить Storybook/гайды с примерами использования и ограничениями.  
- **DoR:** реестр блоков утверждён и поддерживается в `docs/site-editor-block-library.md`; UX-макеты каталога, карточек и инспектора согласованы (по интерактивным прототипам); контракт адаптеров данных и требования к локализации документированы; готовы мок‑данные и фикстуры для предпросмотра, e2e сценарии описаны.  
- **DoD:** библиотека отображает блоки с поиском, фильтрами и предпросмотром по локалям; карточки содержат описание, владельца, ссылки на документацию и пример; формы настроек валидируют схему и источники данных с обработкой ошибок/успеха; manual/auto источники подключаются к API/мокам; Storybook, JSON schema и документация обновлены; unit/e2e тесты покрывают поиск, фильтры, выбор блока, настройку источника и локализованный предпросмотр (RU/EN).  
- **AC:** пользователь видит каталог с фильтрами и поиском, открывает карточку, изучает правила использования, выбирает блок, настраивает источник данных (manual/auto/mixed), переключает локаль и получает корректный предпросмотр или понятные сообщения об ошибках; документация на блок доступна из UI.

### 12. Workflow и права публикации
- **Шаги:** закрепить роли `site.viewer/editor/reviewer/publisher/admin` в IAM, ограничить ими эндпоинты и UI; поддержать статусы `review_status` с режимом self-approve для пользователей с `site.publisher`; обновить редактор страниц/блоков так, чтобы отображать актуальный статус и пояснять отсутствие обязательного ревью; сохранять комментарий к публикации и события в `site_audit_log`; оформить отдельные backlog-эпики на чек-листы, уведомления (Slack/e-mail) и интеграцию с Jira/Linear.  
- **DoR:** согласованы правила выдачи ролей и связь с командами, описан процесс self-approve и формат сообщений в аудит, подтверждён доступ к IAM API, определён шаблон комментария к публикации и перечень backlog-эпиков.  
- **DoD:** все защищённые действия проверяют соответствующую роль; черновики и глобальные блоки возвращают/сохраняют `review_status`, UI отражает self-approve; публикация доступна только пользователям с `site.publisher`, при этом сохраняются комментарий и запись в `site_audit_log`; тесты покрывают happy-path и отказ без прав; backlog-эпики на чек-листы, уведомления и Jira/Linear созданы с минимальными требованиями.  
- **AC:** пользователь без `site.publisher` не может запустить публикацию; владелец с `site.publisher` видит, что ревью не требуется и публикует страницу без дополнительных переходов статуса; audit log фиксирует операции (черновик, ревью, публикация) с актором и комментариями; UI корректно работает при единственном редакторе и при появлении отдельного ревьюера.

### 13. Метрики и отчётность
- **Шаги:** согласовать MVP-набор метрик (страница: просмотры, уникальные пользователи, CTR CTA, конверсия, bounce rate; глобальный блок: охват, показы, клики, CTR, топ-страницы), описать контракт аналитики и задержки; реализовать backend-адаптер к источнику (DWH/ClickHouse или REST), кэширование/валидаторы SLA; обновить UI редактора страниц и глобальных блоков карточками KPI + спарклайнами и инструментами выбора периода (7/30 дней), вывести «до/после публикации»; дополнить вкладку «Активность» событиями из `site_audit_log` и алертами по метрикам, включая состояния «данные недоступны»/«старше SLA».  
- **DoR:** список KPI утверждён с маркетингом/аналитикой, известны источники данных и ключи атрибуции (`page_id`, `slug`, `block_id`), подтверждены SLA и лимиты, есть доступ к API/SQL и черновой OpenAPI/DDL; UX-макеты карточек KPI и ленты активности согласованы.  
- **DoD:** backend отдаёт агрегированные KPI страниц и глобальных блоков с учётом выбранного периода и fallback при недоступности аналитики; UI отображает карточки с фактом, трендом, дельтой и предупреждением о задержке, сравнение «до/после публикации»; лента активности объединяет события аудита и алерты метрик, фильтруется по типу; покрыты unit/интеграционные тесты на адаптеры и UI-сценарии, настроены тестовые фикстуры.  
- **AC:** редактор видит актуальные KPI страницы и её глобальных блоков за выбранный период, получает предупреждение при отклонении SLA или просадке > N%; лента активности показывает публикации/откаты и метрик-алерты в хронологии; при недоступности аналитики выводится явное сообщение и данные не устаревают без индикатора.

### 14. UX, документация и обучение
- **Шаги:** подготовить гайды, записать walkthrough, обновить wiki, провести внутреннее обучение.  
- **DoR:** основная функциональность (шаги 1–13) стабильна, есть финальные макеты.  
- **DoD:** гайды и видео опубликованы, проведена сессия обучения, собран и обработан фидбэк.  
- **AC:** пользователи проходят тестовую публикацию по инструкции, документация покрывает ключевые сценарии.

### 15. Тестирование и rollout
- **Шаги:** автоматические тесты (unit/e2e), пилот на ограниченном наборе страниц, план отката.  
- **DoR:** предыдущие шаги завершены, сценарии тестов готовы.  
- **DoD:** CI зелёный, пилот проведён, замечания исправлены, план развёртывания утверждён.  
- **AC:** ключевые пользователи подтверждают готовность, нет блокирующих багов, есть готовый план отката.

## Решения, которые не реализуются
- Не создаём полноценный WYSIWYG редактор верстки — остаёмся в блоковой модели.
- Не переносим контент в стороннюю CMS — используем текущую инфраструктуру HomeConfig/HomeComposer.
