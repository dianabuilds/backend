# ADR: Управление публичной главной и дев-блогом через конфигурацию

## Status
Accepted — 09.10.2025

## Context
- Публичная главная должна отображать редакционно отобранные блоки (новости/dev-блог, квесты, входные точки в ноды, популярное, рекомендации редакции и общие рекомендации).
- Сегодня главная отсутствует, а список дев-блога доступен только через админские инструменты; API выдаёт данные для блога, но нет публичного представления.
- Контент-команда и продакты требуют полного контроля над тем, что видит пользователь, без перекомпиляции фронтенда.
- Требуется возможность временно скрывать блоки (например, квесты до готовности контента) и комбинировать ручной/автоматический отбор материалов.

## Problem Statement
1. Нет централизованного способа описать состав главной страницы и опубликовать его для фронтенда.
2. Нет административного интерфейса для управления блоками и предпросмотра будущей главной.
3. Дев-блог технически доступен (FastAPI выдаёт список постов), но отсутствует публичный UI, карта URL и интеграция с главной.
4. Нужно гарантировать локализацию, кеширование и аудит изменений (кто и когда обновил главную).

## Decision
### 1. Модель конфигурации
- Вводим сущность `home_config` (таблица `product_home_configs`). Поля: `id`, `slug`, `version`, `status` (`draft`/`published`), `data` (JSONB с описанием блоков), `created_by`, `updated_by`, `created_at`, `updated_at`.
- Ровно один активный published-конфиг; черновиков может быть несколько, но админка работает с последним черновиком.
- JSON-схема блока:
  ```json
  {
    "id": "header-1",
    "type": "hero",
    "title": "Заголовок",
    "enabled": true,
    "slots": {
      "headline": "string",
      "cta": { "label": "string", "href": "string" }
    },
    "dataSource": {
      "mode": "manual" | "auto",
      "entity": "node" | "quest" | "dev_blog",
      "filter": { "tag": "string", "limit": 6, "order": "publish_at_desc" },
      "items": ["node-id-1", "node-id-2"]
    }
  }
  ```
- Набор допустимых типов блоков фиксирован (hero, dev_blog_list, quests_carousel, nodes_carousel, popular_carousel, editorial_picks, recommendations, custom_carousel). Расширение — отдельное решение.

- Схема хранения:
  - Таблица `product_home_configs`: `id` (uuid, PK, `gen_random_uuid()`), `slug` (уникальный), `version` (bigint, default 1), `status` (enum `home_config_status`), `data` (JSONB), аудитные поля `created_by`/`updated_by`, временные метки `created_at`/`updated_at`, `published_at`, ссылка `draft_of` на исходный конфиг.
  - Таблица `home_config_audits`: `id` (uuid, PK), `config_id` (FK → `product_home_configs.id`, CASCADE), `version`, `action`, `actor`, `data` (snapshot JSONB), `created_at`, индекс `ix_home_config_audits_config_id(config_id, version)`.
  - Enum `home_config_status` со значениями `draft`, `published` и индексом `ix_product_home_configs_status`.


### 2. API
- Публичный `GET /v1/public/home` возвращает опубликованную конфигурацию с разрешёнными данными (карточки, ссылки, тексты) и HTTP-кешем (ETag, `Cache-Control: public, max-age=300`). Источник данных формируется сервисом HomeComposer, который разворачивает блоки конфигурации: 
  - manual — подтягивает сущности по ID из соответствующих use-case (nodes, quests, dev_blog);
  - auto — строит запрос на основе фильтра (например, популярное = сортировка по просмотрам).
- Админские маршруты:
  - `GET /v1/admin/home` — вернуть текущий черновик + метаданные.
  - `PUT /v1/admin/home` — заменить черновик (валидация JSON-схемы, проверка существования ссылок).
  - `POST /v1/admin/home/publish` — пометить черновик как published (версирование, аудит).
  - `POST /v1/admin/home/preview` — получить рендер, не затрагивая published (для предпросмотра).
- Добавляем `GET /v1/nodes/dev-blog/{slug}` и `GET /v1/nodes/dev-blog/{slug}/preview` (для предпросмотра неопубликованных постов).

### 3. Дев-блог
- Посты остаются нодами с тегом `dev-blog`. Сервис DevBlogService дополняем методами `get_post_by_slug`, `get_adjacent_posts`.
- В home_config блок `dev_blog_list` может ссылаться на `dataSource.mode = auto` (последние N опубликованных) или `manual` (ручной выбор).
- Публичный фронтенд добавляет маршруты `/dev-blog` и `/dev-blog/:slug`, рендерит список и детальную страницу, поддерживает SEO-метатеги и локализацию.

### 4. Админский UI для главной
- В React-приложении (`apps/web`) создаём страницу "Главная" в разделе управления контентом:
  - Панель блоков с преднастроенными типами.
  - Canvas с текущим черновиком: drag-and-drop, включение/отключение, редактирование параметров, выбор сущностей.
  - Превью (iframe или инлайновый рендер) с использованием публичных компонентов в режиме `preview`.
  - Кнопки "Сохранить черновик" и "Опубликовать" (с подтверждением).
  - Аудит: отображение автора и времени последней публикации.
- В разделе нод добавляем фильтр "Dev Blog" для быстрого отбора и флаг "Показывать на главной" (сохраняется в тегах/метаданных).

### 5. Публичный фронтенд
- Создаём страницу `/` (главная) с SSR-совместимой загрузкой `GET /v1/public/home`. Блоки рендерятся на основе `type`, локализация через `@ui` и словарь.
- Общие требования: skeleton-стейты, обработка ошибок (fallback блок "Раздел временно недоступен"), отслеживание RUM-событий (`home.block_rendered`).
- Настраиваем fallback, если блок выключен или пуст — он не отображается.

### 6. Кеширование и аудит
- Результат `GET /v1/public/home` кешируем в Redis (ttl 5 минут) для защиты от пиков.
- В аудит добавляем запись `home.publish` с автором и версией.
- Предпросмотр не кешируется публично, требует админских прав.

## Implementation Plan
### Backend (FastAPI)
1. Создать миграцию и модель `product_home_configs`.
2. Реализовать HomeConfigRepository и HomeComposer (manual/auto data sources).
3. Добавить публичный и админские маршруты, тесты на схему и права доступа.
4. Обновить DevBlogService (деталь, соседи) + новые эндпоинты.
5. Внедрить кеш (Redis/InMemory) и аудит публикаций.

### Frontend — Админка (`apps/web`)
1. Создать страницу `/management/home` с редактором блоков (drag&drop, формы настройки, предпросмотр).
2. Реализовать API-клиент `shared/api/home.ts` (getDraft, saveDraft, publish, preview).
3. Добавить фильтр Dev Blog в `/nodes/library` и флаг "Показывать на главной" в карточках.
4. Интегрировать локализацию (ru/en) для всех новых текстов.

### Frontend — Публичный веб (`apps/web`)
1. Добавить маршруты `/`, `/dev-blog`, `/dev-blog/:slug` в `App.tsx`.
2. Реализовать компоненты: `HomePage`, `DevBlogListPage`, `DevBlogPostPage`, переиспользуя UI-паттерны из гайда.
3. Подключить загрузку конфигурации и отображение блоков; обработать ошибки, пустые состояния, лоадеры.
4. Настроить SEO (meta, OpenGraph) и RUM-события.

### QA и DevOps
1. Написать автоматические smoke-тесты для новых API (home, dev-blog detail).
2. Настроить тестовые данные и чек-листы для контент-команды.
3. Обновить мониторинг (добавить метрику успешных публикаций, latency `/v1/public/home`).

### Документация и процессы
1. Обновить README/вики по работе с дев-блогом и главной.
2. Описать правила публикации (кто может публиковать, как откатить).
3. Подготовить обучающие материалы для контент-редакторов.

## Consequences
- Плюсы: гибкость управления главной без деплоя, быстрые кампании, единый механизм публикации и предпросмотра, интеграция дев-блога в пользовательский опыт.
- Минусы: растёт сложность админки и требований к QA; необходимо поддерживать миграцию данных и backwards compatibility блока.
- Риски: некорректная конфигурация может привести к пустым блокам на главной (смягчаем валидацией и предпросмотром); auto-источники создают нагрузку на базы (решаем кешем и лимитами).

## Open Questions
- Нужно ли версионирование и откат к произвольной старой версии? (предлагается реализовать в следующей итерации)
- Требуются ли A/B-эксперименты для главной? (при появлении — расширение схемы конфигурации)
